<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¨ì–´ ì‹œí—˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* í„°ì¹˜ ë°˜ì‘ ì†ë„ ìµœì í™” */
        body { 
            background-color: #f8f9fa; 
            touch-action: manipulation; 
            overscroll-behavior: none;
        } 
        
        .exam-card {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            min-height: 100vh; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ë‹¨ì–´ í…ìŠ¤íŠ¸ */
        .word-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: #212529;
            margin: 10px 0;
            word-break: break-all;
        }

        /* ë°œìŒ ì•„ì´ì½˜ */
        .pronunciation-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #e7f1ff;
            color: #0d6efd;
            font-size: 1.2rem;
            margin-left: 10px;
            cursor: pointer;
            /* í„°ì¹˜ ì¸ì‹ ê°œì„  */
            position: relative; 
            z-index: 10; 
        }

        /* íƒ€ì´ë¨¸ ë°” */
        .timer-container {
            height: 6px;
            background-color: #e9ecef;
            margin-bottom: 20px;
            border-radius: 3px;
            overflow: hidden;
            width: 100%;
        }
        .timer-bar { 
            height: 100%; 
            background-color: #0d6efd; 
            width: 100%; 
            /* ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ì¦‰ê° ë°˜ì‘ ìœ„í•´) or ì§§ê²Œ ì„¤ì • */
            transition: width 0.05s linear; 
        }
        .timer-bar.danger { background-color: #dc3545; }

        /* [í•™ìŠµ ëª¨ë“œ] í„°ì¹˜ ì˜ì—­ - í™”ë©´ ì „ì²´ í™œìš© */
        .touch-area {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: 20px 0;
            border-radius: 15px;
            background-color: #ffffff; /* íˆ¬ëª…ë„ ì œê±° */
            /* í´ë¦­ ëª…í™•ì„±ì„ ìœ„í•´ í…Œë‘ë¦¬ ì¶”ê°€ */
            border: 2px dashed #dee2e6;
        }
        .touch-area:active { background-color: #f8f9fa; border-color: #adb5bd; }
        .tap-hint { color: #adb5bd; font-size: 0.9rem; margin-top: 15px; }

        /* [ì‹œí—˜ ëª¨ë“œ] ì…ë ¥ì°½ */
        .input-answer {
            font-size: 1.3rem;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
            margin-bottom: 0;
            width: 100%;
            background-color: #fff;
        }
        .input-answer:focus { border-color: #0d6efd; outline: none; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); }
        .input-answer.correct { border-color: #198754; background-color: #d1e7dd; }
        .input-answer.wrong { border-color: #dc3545; background-color: #f8d7da; }

        /* ê²°ê³¼ í…Œì´ë¸” */
        .result-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; font-size: 0.9rem; }
        .result-table td { vertical-align: middle; padding: 12px 8px; font-size: 0.95rem; }
        .correct-row { background-color: #f6fff9; }
        .wrong-row { background-color: #fff5f5; }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
        .bottom-btn-area {
            margin-top: auto;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 16px;
        }
    </style>
</head>
<body>

<div class="exam-card">
    
    <div id="headerInfo">
        <div class="d-flex justify-content-between text-muted mb-3 small align-items-center">
            <span class="fw-bold text-truncate" style="max-width: 60%;">{{ book_title }}</span>
            <span class="badge bg-light text-dark border"><span id="currentIndex">1</span> / {{ words_json|length }}</span>
        </div>
        
        <div class="timer-container" id="timerContainer">
            <div id="timerBar" class="timer-bar"></div>
        </div>
    </div>

    <div id="questionArea" style="display: contents;">
        
        <div class="d-flex justify-content-center align-items-center mt-2 mb-3">
            <div id="wordQuestion" class="word-display">Ready</div>
            <div class="pronunciation-btn shadow-sm" onclick="speakWord(event)">ğŸ”Š</div>
        </div>

        <div id="learningArea" style="display: none; flex-grow: 1; flex-direction: column;">
            <div class="touch-area" onclick="handleLearningClick()">
                <div id="learningAnswer" class="fs-1 fw-bold text-primary mb-3 text-center" style="display:none;"></div>
                <div id="learningExample" class="text-muted fst-italic px-3 text-center" style="display:none; line-height: 1.5;"></div>
                
                <div id="touchHint" class="tap-hint">
                    ğŸ‘† í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì •ë‹µì´ ë³´ì…ë‹ˆë‹¤
                </div>
            </div>

            <div class="bottom-btn-area">
                <button id="nextWordBtn" class="btn btn-primary btn-large shadow" style="display:none;" onclick="nextQuestion()">
                    ë‹¤ìŒ ë‹¨ì–´ <small class="fw-normal">(Touch)</small>
                </button>
            </div>
        </div>

        <div id="testArea" style="display: none; flex-grow: 1;">
            <div class="d-flex flex-column justify-content-center h-50">
                <form id="answerForm" onsubmit="event.preventDefault(); checkAnswer();" autocomplete="off">
                    <input type="text" id="answerInput" class="input-answer shadow-sm" 
                           placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" 
                           enterkeyhint="go"
                           autocomplete="off">
                </form>
                <div class="text-center mt-3 text-muted small">
                    ì…ë ¥ í›„ <span class="badge bg-secondary">ì—”í„°</span> ë˜ëŠ” <span class="badge bg-secondary">ì´ë™</span>ì„ ëˆ„ë¥´ì„¸ìš”
                </div>
            </div>
            </div>
    </div>

    <div id="resultArea" style="display: none;">
        <h3 class="fw-bold mb-4 text-center" id="scoreTitle">ê²°ê³¼ ë¦¬í¬íŠ¸</h3>
        <div class="alert alert-light border mb-4 text-center shadow-sm" id="scoreMsg"></div>
        
        <div class="table-responsive border rounded-3 mb-4 shadow-sm" style="max-height: 50vh; overflow-y: auto;">
            <table class="table result-table mb-0">
                <thead class="sticky-top border-bottom">
                    <tr>
                        <th>ë‹¨ì–´</th>
                        <th>ë‚´ ë‹µ</th>
                        <th>ì •ë‹µ</th>
                        <th>ê²°ê³¼</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>

        <div class="bottom-btn-area">
            <a href="/vocab/" class="btn btn-primary btn-large shadow">í™•ì¸ (ë©”ì¸ìœ¼ë¡œ)</a>
        </div>
    </div>

</div>

<script>
    // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const words = {{ words_json|safe }};
    const mode = "{{ mode }}"; 
    const isPractice = {{ is_practice|yesno:"true,false" }};
    const isLearning = {{ is_learning|yesno:"true,false" }};
    const isMonthly = {{ is_monthly|yesno:"true,false" }};
    const testId = "{{ test_id|default:'' }}";

    // ìƒíƒœ ë³€ìˆ˜
    let currentIndex = 0;
    let score = 0;
    let userAnswers = [];
    let isProcessing = false; 
    
    // íƒ€ì´ë¨¸ ê´€ë ¨
    let timerInterval = null;
    let timeLeft = 5000;
    const totalTime = 5000;

    // DOM ìš”ì†Œ
    const wordEl = document.getElementById('wordQuestion');
    const inputEl = document.getElementById('answerInput');
    const timerBar = document.getElementById('timerBar');
    const timerContainer = document.getElementById('timerContainer');
    
    // í•™ìŠµ ëª¨ë“œ ìš”ì†Œ
    const learningArea = document.getElementById('learningArea');
    const learningAnswer = document.getElementById('learningAnswer');
    const learningExample = document.getElementById('learningExample');
    const touchHint = document.getElementById('touchHint');
    const nextWordBtn = document.getElementById('nextWordBtn');
    
    const testArea = document.getElementById('testArea');

    // === ì‹œì‘ ===
    window.onload = function() {
        if (!words || words.length === 0) {
            alert("í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = "/vocab/";
            return;
        }
        
        if (isLearning) {
            timerContainer.style.visibility = 'hidden';
            testArea.style.display = 'none';
            learningArea.style.display = 'flex';
        } else {
            learningArea.style.display = 'none';
            testArea.style.display = 'block';
        }

        showQuestion();
    };

    // === ë¬¸ì œ í‘œì‹œ ===
    function showQuestion() {
        isProcessing = false;
        
        const currentWord = words[currentIndex];
        wordEl.innerText = currentWord.english;
        document.getElementById('currentIndex').innerText = currentIndex + 1;
        
        setTimeout(() => speakWord(), 300);

        if (isLearning) {
            learningAnswer.style.display = 'none';
            learningExample.style.display = 'none';
            learningAnswer.innerText = currentWord.korean;
            learningExample.innerText = currentWord.example || "";
            touchHint.style.display = 'block';
            nextWordBtn.style.display = 'none';
        } else {
            inputEl.value = "";
            inputEl.disabled = false;
            // [ìˆ˜ì •] ìƒ‰ìƒ ì´ˆê¸°í™” ì½”ë“œ ì‚­ì œ (ë” ì´ìƒ ìƒ‰ì„ ì•ˆ ì…íˆë¯€ë¡œ ì´ˆê¸°í™”ë„ í•„ìš” ì—†ìŒ)
            inputEl.focus();
            resetAndStartTimer();
        }
    }

    // === [í•™ìŠµ ëª¨ë“œ] í„°ì¹˜ ë¡œì§ ===
    window.handleLearningClick = function() {
        if (learningAnswer.style.display === 'block') return;
        learningAnswer.style.display = 'block';
        learningExample.style.display = 'block';
        touchHint.style.display = 'none';
        nextWordBtn.style.display = 'block';
    };

    // === [ì‹œí—˜ ëª¨ë“œ] íƒ€ì´ë¨¸ ===
    function resetAndStartTimer() {
        if (isLearning) return;
        if (timerInterval) clearInterval(timerInterval);
        
        timeLeft = totalTime;
        timerBar.style.width = "100%";
        timerBar.classList.remove('danger');

        timerInterval = setInterval(() => {
            timeLeft -= 50;
            const percent = (timeLeft / totalTime) * 100;
            timerBar.style.width = percent + "%";
            if (percent < 30) timerBar.classList.add('danger');

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (!isProcessing) {
                    processResult(false, "(ì‹œê°„ ì´ˆê³¼)");
                }
            }
        }, 50);
    }

    // === [ì‹œí—˜ ëª¨ë“œ] ì •ë‹µ ì²´í¬ ===
    window.checkAnswer = function() {
        if (isLearning) return;
        if (isProcessing) return;

        const userInput = inputEl.value.trim();
        const dbAnswer = words[currentIndex].korean; 
        
        if (!userInput) return; 

        const correctAnswers = dbAnswer.split(',').map(word => word.trim());
        const isCorrect = correctAnswers.includes(userInput);

        processResult(isCorrect, userInput);
    }

    function processResult(isCorrect, userInput) {
        isProcessing = true;
        clearInterval(timerInterval);
        
        // [ìˆ˜ì •] ì •ë‹µ/ì˜¤ë‹µ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ ì½”ë“œ ì‚­ì œ
        // if (isCorrect) inputEl.classList.add('correct');
        // else inputEl.classList.add('wrong');

        userAnswers.push({
            english: words[currentIndex].english,
            korean: words[currentIndex].korean,
            user_input: userInput,
            is_correct: isCorrect
        });

        if (isCorrect) score++;

        setTimeout(nextQuestion, 200);
    }

    // === ë‹¤ìŒ ë¬¸ì œ ì´ë™ ===
    window.nextQuestion = function() {
        currentIndex++;
        if (currentIndex < words.length) {
            showQuestion();
        } else {
            finishExam();
        }
    }

    // === TTS ===
    let voices = [];

    // ê¸°ê¸°ì˜ ëª©ì†Œë¦¬ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function setVoiceList() {
        voices = window.speechSynthesis.getVoices();
    }

    // ëª©ì†Œë¦¬ ëª©ë¡ì€ ë¹„ë™ê¸°ë¡œ ë¡œë“œë˜ë¯€ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = setVoiceList;
    }

    window.speakWord = function(event) {
        if(event) event.stopPropagation();
        
        if ('speechSynthesis' in window) {
            // ê¸°ì¡´ ëŒ€ê¸°ì—´ ì·¨ì†Œ
            window.speechSynthesis.cancel();

            const text = words[currentIndex].english;
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 1. ê¸°ë³¸ ì–¸ì–´ ì„¤ì •
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9; // ì†ë„ (0.1 ~ 10)

            // 2. [í•µì‹¬] ë¯¸êµ­ ì˜ì–´ ëª©ì†Œë¦¬ ê°•ì œ ì°¾ê¸°
            // ëª©ì†Œë¦¬ ëª©ë¡ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë‹¤ì‹œ í˜¸ì¶œ
            if (voices.length === 0) {
                voices = window.speechSynthesis.getVoices();
            }

            // ìš°ì„ ìˆœìœ„: 
            // 1. "Samantha" (ì•„ì´í°ì˜ ëŒ€í‘œì ì¸ ë¯¸êµ­ ì—¬ì„± ëª©ì†Œë¦¬)
            // 2. ì´ë¦„ì— "US"ë‚˜ "United States"ê°€ ë“¤ì–´ê°„ ëª©ì†Œë¦¬
            // 3. ì–¸ì–´ ì½”ë“œê°€ "en-US"ì¸ ëª©ì†Œë¦¬
            const targetVoice = voices.find(v => v.name === 'Samantha') || 
                                voices.find(v => v.lang === 'en-US' && v.name.includes('US')) ||
                                voices.find(v => v.lang === 'en-US');

            // ì°¾ì€ ëª©ì†Œë¦¬ê°€ ìˆìœ¼ë©´ ì ìš©
            if (targetVoice) {
                utterance.voice = targetVoice;
            }

            window.speechSynthesis.speak(utterance);
        }
    }

    // === ê²°ê³¼ ì²˜ë¦¬ ===
    function finishExam() {
        document.getElementById('headerInfo').style.display = 'none';
        document.getElementById('questionArea').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';

        if (isLearning) {
            document.getElementById('scoreTitle').innerText = "í•™ìŠµ ì™„ë£Œ";
            document.getElementById('scoreMsg').innerText = "ì˜¤ëŠ˜ì˜ ë‹¨ì–´ í•™ìŠµì„ ë§ˆì³¤ìŠµë‹ˆë‹¤!";
            renderTable([]);
            return;
        }

        if (!isPractice) {
            saveResultToServer();
        } else {
            document.getElementById('scoreMsg').innerHTML = `<strong>ì—°ìŠµ ê²°ê³¼:</strong> ${score} / ${words.length} ì `;
            renderTable(null);
        }
    }

    function saveResultToServer() {
        const data = {
            test_id: testId,
            mode: mode,
            score: score,
            wrong_count: words.length - score,
            details: userAnswers,
            is_monthly: isMonthly
        };

        fetch("{% url 'vocab:save_result' %}", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // [ìˆ˜ì •] ì›”ë§í‰ê°€(85ì )ì™€ ì¼ë°˜ì‹œí—˜(27ì ) í†µê³¼ ê¸°ì¤€ ë¶„ë¦¬ ì ìš©
                let isPass = false;
                if (isMonthly) {
                    isPass = score >= 85; // ì›”ë§í‰ê°€ ê¸°ì¤€
                } else {
                    isPass = score >= 27; // ë„ì „/ì˜¤ë‹µëª¨ë“œ ê¸°ì¤€ (30ë¬¸ì œ ì¤‘ 27)
                }

                const passMsg = !isPass 
                    ? "<br><span class='text-danger fw-bold'>ë¶ˆí•©ê²© (ì¬ì‹œí—˜ í•„ìš”)</span>" 
                    : "<br><span class='text-success fw-bold'>í†µê³¼! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</span>";
                
                document.getElementById('scoreMsg').innerHTML = `<strong>ìµœì¢… ì ìˆ˜:</strong> ${score}ì  ${passMsg}`;
                renderTable(data.detail_ids);
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
            }
        });
    }

    function renderTable(detailIds) {
        const tbody = document.getElementById('resultTableBody');
        tbody.innerHTML = "";

        userAnswers.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = item.is_correct ? 'correct-row' : 'wrong-row';
            
            let status = item.is_correct ? '<span class="text-success fw-bold">O</span>' : '<span class="text-danger fw-bold">X</span>';
            
            if (!item.is_correct && detailIds && detailIds.length > index) {
                const detailId = detailIds[index];
                // [ìˆ˜ì •] type="button" ì†ì„± ì¶”ê°€
                status += `<br><button type="button" class="btn btn-outline-secondary btn-sm mt-1 shadow-sm btn-correction-request" style="font-size: 0.7rem; padding: 4px 8px;" data-id="${detailId}">ì •ë‹µìš”ì²­</button>`;
}

            tr.innerHTML = `
                <td class="fw-bold">${item.english}</td>
                <td class="small">${item.user_input || '-'}</td>
                <td class="small text-primary">${item.korean}</td>
                <td class="text-center">${status}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    document.addEventListener('click', function(e) {
    // 1. í´ë¦­ëœ ìš”ì†Œê°€ 'ì •ë‹µìš”ì²­ ë²„íŠ¼'ì¸ì§€ í™•ì¸
    if (e.target && e.target.classList.contains('btn-correction-request')) {
        e.preventDefault(); // ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ (í•„ìˆ˜)
        e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
        
        const btn = e.target;
        const detailId = btn.getAttribute('data-id');

        // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ë²„íŠ¼ì´ë©´ ë¬´ì‹œ
        if (btn.disabled) return;

        // 2. ë²„íŠ¼ UI ì¦‰ì‹œ ë³€ê²½ (íŒì—… ì—†ì´ í”¼ë“œë°±)
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "ì²˜ë¦¬ ì¤‘...";

        // 3. ì„œë²„ ìš”ì²­ (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)
        fetch("{% url 'vocab:request_correction' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken() // CSRF í† í° ì•ˆì „í•˜ê²Œ ì¶”ê°€ (ì•„ë˜ í•¨ìˆ˜ í•„ìš”)
            },
            body: JSON.stringify({ 
                detail_id: detailId, 
                is_monthly: isMonthly 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // ì„±ê³µ: ë²„íŠ¼ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
                btn.innerText = "ìš”ì²­ë¨";
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-secondary');
            } else {
                // ì‹¤íŒ¨: ì—ëŸ¬ ë©”ì‹œì§€ í›„ ë³µêµ¬
                alert("ì˜¤ë¥˜: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                btn.disabled = false;
                btn.innerText = originalText;
            }
        })
        .catch(err => {
            console.error(err);
            // í†µì‹  ì—ëŸ¬: ì¡°ìš©íˆ ë³µêµ¬í•˜ê±°ë‚˜ alert í‘œì‹œ
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }
});

// [ë³´ì¡°] CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ì—†ìœ¼ë©´ ì¶”ê°€í•´ì£¼ì„¸ìš”)
function getCsrfToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>