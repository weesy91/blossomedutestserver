<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ì„¤ì • - Blossom Edu</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .config-container {
            max-width: 700px; 
            margin: 0 auto 40px auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .nav-pills .nav-link {
            border-radius: 12px;
            padding: 12px;
            color: #495057;
            background-color: #f1f3f5;
            margin: 0 5px;
            font-weight: 700;
            transition: all 0.2s;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef;
        }

        /* íˆíŠ¸ë§µ ì»¨í…Œì´ë„ˆ */
        #cal-heatmap-container {
            width: 100%;
            overflow-x: auto;
            padding-top: 50px; /* íˆ´íŒ ì˜ë¦¼ ë°©ì§€ìš© ì—¬ë°± */
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            scrollbar-width: thin;
        }

        @media (max-width: 576px) {
            .config-container { padding: 20px; }
            .header-bar h4 { font-size: 1.2rem; }
            .nav-pills .nav-link { font-size: 0.9rem; padding: 10px; }
        }

        .section-label {
            font-weight: 700;
            font-size: 1rem;
            color: #343a40;
            margin-bottom: 8px;
        }
        .form-select, .form-control {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            font-size: 0.95rem;
        }
        .form-select:focus, .form-control:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 4px rgba(77, 171, 247, 0.1);
        }
        .mode-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }
        .mode-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mode-card.selected { border-color: #0d6efd; background-color: #f8f9fa; }
        .mode-icon { font-size: 1.4rem; margin-right: 12px; width: 30px; text-align: center; }
        .mode-title { font-weight: 800; font-size: 1rem; margin-bottom: 1px; }
        .mode-desc { font-size: 0.8rem; color: #868e96; margin: 0; }
        .btn-start {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            margin-top: 15px;
            background-color: #0d6efd;
            border: none;
            color: white;
        }
        .btn-start:hover { background-color: #0b5ed7; color: white; }
        .btn-start:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-bar">
            <h4 class="fw-bold m-0 text-primary">ğŸ“ ì‹œí—˜ ì„¤ì •</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="fw-bold text-dark">
                    ğŸ§‘â€ğŸ“ {{ user.profile.name|default:user.username }} í•™ìƒ
                </span>
                <a href="{% url 'core:logout' %}" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                    ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3" style="max-width: 700px; margin: 0 auto;">
            <a href="{% url 'vocab:search_word_page' %}" class="btn btn-outline-primary shadow-sm fw-bold">
                <i class="bi bi-search me-1"></i> ë‹¨ì–´ ê²€ìƒ‰ & ì˜¤ë‹µ ì¶”ê°€
            </a>
        </div>

        <div class="config-container">
            
            <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-status-tab" data-bs-toggle="pill" data-bs-target="#pills-status" type="button" role="tab">
                        ğŸ“Š ë‚´ í•™ìŠµ í˜„í™©
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-learning-tab" data-bs-toggle="pill" data-bs-target="#pills-learning" type="button" role="tab">
                        ğŸ“ ë‹¨ì–´ í•™ìŠµí•˜ê¸°
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-status" role="tabpanel">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm border bg-white">
                                <div class="card-header bg-transparent border-0 pt-3 px-3">
                                    <ul class="nav nav-pills card-header-pills" id="rankingTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link {% if active_event %}active{% endif %} py-1 px-3 small fw-bold" 
                                                    id="event-rank-tab" data-bs-toggle="tab" data-bs-target="#event-rank" type="button">
                                                ğŸ† ì´ë²¤íŠ¸
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link {% if not active_event %}active{% endif %} py-1 px-3 small fw-bold" 
                                                    id="month-rank-tab" data-bs-toggle="tab" data-bs-target="#month-rank" type="button">
                                                ğŸ”¥ ì´ë‹¬ì˜ ì™•
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                                <div class="card-body p-3 pt-2">
                                    <div class="tab-content" id="rankingTabContent">
                                        
                                        <div class="tab-pane fade {% if active_event %}show active{% endif %}" id="event-rank" role="tabpanel">
                                            {% if active_event %}
                                                <div class="alert alert-warning py-2 px-2 mb-3 d-flex align-items-center" style="font-size: 0.85rem;">
                                                    <span class="fs-5 me-2">ğŸ“¢</span>
                                                    <div>
                                                        <strong class="d-block text-dark">{{ active_event.title }}</strong>
                                                        <span class="text-muted">ëŒ€ìƒ: {{ active_event.target_book.title }}</span>
                                                    </div>
                                                </div>
                                                <ul class="list-group list-group-flush small">
                                                    {% for ranker in event_ranking %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-1 py-2">
                                                        <div>
                                                            {% if ranker.rank == 1 %}ğŸ¥‡{% elif ranker.rank == 2 %}ğŸ¥ˆ{% elif ranker.rank == 3 %}ğŸ¥‰{% else %}<span class="badge bg-light text-dark border ms-1">{{ ranker.rank }}</span>{% endif %}
                                                            <span class="fw-bold ms-2">{{ ranker.name }}</span>
                                                        </div>
                                                        <span class="text-danger fw-bold">{{ ranker.score }} ì </span>
                                                    </li>
                                                    {% empty %}
                                                    <li class="text-center text-muted py-4 small">ì•„ì§ ì´ë²¤íŠ¸ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.<br>1ë“±ì„ ë…¸ë ¤ë³´ì„¸ìš”!</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div class="text-center py-5 text-muted small">
                                                    <i class="bi bi-gift fs-1 mb-2 d-block opacity-50"></i>
                                                    ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ ê¸°ëŒ€í•´ì£¼ì„¸ìš”! ğŸ
                                                </div>
                                            {% endif %}
                                        </div>

                                        <div class="tab-pane fade {% if not active_event %}show active{% endif %}" id="month-rank" role="tabpanel">
                                            <div class="mb-3 text-secondary small fw-bold ps-1">
                                                ğŸ“… ì´ë²ˆ ë‹¬ ëˆ„ì  ì ìˆ˜ TOP 5
                                            </div>
                                            <ul class="list-group list-group-flush small">
                                                {% for ranker in monthly_ranking %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-1 py-2">
                                                    <div>
                                                        {% if ranker.rank == 1 %}ğŸ¥‡{% elif ranker.rank == 2 %}ğŸ¥ˆ{% elif ranker.rank == 3 %}ğŸ¥‰{% else %}<span class="badge bg-light text-dark border ms-1">{{ ranker.rank }}</span>{% endif %}
                                                        <span class="fw-bold ms-2">{{ ranker.name }}</span>
                                                    </div>
                                                    <span class="text-primary fw-bold">{{ ranker.score }} XP</span>
                                                </li>
                                                {% empty %}
                                                <li class="text-center text-muted py-4 small">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm border bg-light">
                                <div class="card-header bg-transparent fw-bold text-primary border-0 pt-3 ps-3">
                                    ğŸ“ˆ ë‚˜ì˜ ì‹¤ë ¥ ë³€í™”
                                </div>
                                <div class="card-body p-2 pt-0" style="height: 150px;">
                                    <canvas id="growthChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border mb-4">
                        <div class="card-header bg-white fw-bold py-2 border-bottom-0">
                            ğŸŒ± í•™ìŠµ ì”ë”” (Study Heatmap)
                            <small class="text-muted fw-normal ms-2" style="font-size: 0.8rem;">ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì„ ë§Œë“­ë‹ˆë‹¤!</small>
                        </div>
                        <div class="card-body pt-0 pb-3">
                            <div id="cal-heatmap-container">
                                <div id="cal-heatmap"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-learning" role="tabpanel">
                    <div class="alert alert-primary d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                        <div class="small">
                            ì˜¤ëŠ˜ë„ í™”ì´íŒ…! <strong>{{ user.profile.name }}</strong> í•™ìƒì˜ ì—´ì •ì„ ì‘ì›í•©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <div class="section-label">1. ì¶œíŒì‚¬ ì„ íƒ</div>
                            <select id="publisherSelect" class="form-select mb-3" onchange="filterBooks()">
                                <option value="" selected disabled>-- ì„ íƒí•˜ì„¸ìš” --</option>
                                {% for pub in publishers %}
                                    <option value="{{ pub.id }}">{{ pub.name }}</option>
                                {% endfor %}
                                {% if etc_books %}
                                    <option value="etc">ê¸°íƒ€</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <div class="section-label">2. ë‹¨ì–´ì¥ ì„ íƒ</div>
                            <select id="bookSelect" class="form-select mb-3" disabled>
                                <option value="" selected disabled>-- ì¶œíŒì‚¬ ë¨¼ì € --</option>
                                {% for pub in publishers %}
                                    {% for book in pub.wordbook_set.all %}
                                    <option value="{{ book.id }}" class="book-option pub-{{ pub.id }} d-none-custom">{{ book.title }}</option>
                                    {% endfor %}
                                {% endfor %}
                                {% for book in etc_books %}
                                <option value="{{ book.id }}" class="book-option pub-etc d-none-custom">{{ book.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="section-label">3. Day ë²”ìœ„ ì„¤ì •</div>
                        <input type="tel" id="rangeInput" class="form-control" placeholder="ì˜ˆ: 1-5, 7 (ë¹„ì›Œë‘ë©´ ì „ì²´)">
                    </div>

                    <div>
                        <div class="section-label">4. ì‹œí—˜ ëª¨ë“œ ì„ íƒ</div>
                        
                        <div class="mode-card" onclick="selectMode('learning', this)">
                            <div class="mode-icon">ğŸ“–</div>
                            <div>
                                <div class="mode-title text-primary">í•™ìŠµ ëª¨ë“œ</div>
                                <p class="mode-desc">ì •ë‹µê³¼ ì˜ˆë¬¸ì„ ë³´ë©° ì•”ê¸°</p>
                            </div>
                        </div>

                        <div class="mode-card" onclick="selectMode('practice', this)">
                            <div class="mode-icon">ğŸŒ±</div>
                            <div>
                                <div class="mode-title text-success">ì—°ìŠµ ëª¨ë“œ</div>
                                <p class="mode-desc">ê¸°ë¡ ë‚¨ì§€ ì•ŠìŒ (30ë¬¸ì œ)</p>
                            </div>
                        </div>

                        {% if is_wrong_mode_active %}
                            <div class="mode-card" onclick="selectMode('wrong', this)" style="border-color: #ff6b6b; background-color: #fff5f5;">
                                <div class="mode-icon">ğŸš¨</div>
                                <div>
                                    <div class="mode-title text-danger">ì˜¤ë‹µ íƒˆì¶œ ëª¨ë“œ</div>
                                    <p class="mode-desc text-danger">ì·¨ì•½ ë‹¨ì–´ <strong>{{ wrong_count }}ê°œ</strong>ê°€ ìŒ“ì˜€ìŠµë‹ˆë‹¤!</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="mode-card" onclick="selectMode('challenge', this)">
                                <div class="mode-icon">ğŸ”¥</div>
                                <div>
                                    <div class="mode-title text-danger">ë„ì „ ëª¨ë“œ (ì‹œí—˜)</div>
                                    <p class="mode-desc">ê²°ê³¼ ì €ì¥ + ë¶ˆí•©ê²© ì‹œ ì¿¨íƒ€ì„</p>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if is_monthly_period %}
                        <div class="mode-card" onclick="selectMode('monthly', this)" style="border-color: #ffc107; background-color: #fff9db;">
                                <div class="mode-icon">ğŸ“…</div>
                                <div>
                                    <div class="mode-title" style="color: #d68c00;">ì›”ë§ í‰ê°€</div>
                                    <p class="mode-desc">ì´ë²ˆ ë‹¬ í•™ìŠµ ë‚´ìš© ìµœì¢… ì ê²€ (100ë¬¸ì œ)</p>
                                </div>
                            </div>
                    {% endif %}
                    </div>

                    <button id="startBtn" class="btn btn-start" onclick="startExam()" disabled>
                        ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span id="modalDate"></span> í•™ìŠµ ê¸°ë¡
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light" id="modalContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜
        let selectedMode = null;

        function filterBooks() {
            const pubSelect = document.getElementById('publisherSelect');
            const bookSelect = document.getElementById('bookSelect');
            const selectedPubId = pubSelect.value;
            const options = document.querySelectorAll('.book-option');

            bookSelect.value = "";
            bookSelect.disabled = false;
            
            let hasBooks = false;
            options.forEach(opt => {
                if (opt.classList.contains('pub-' + selectedPubId)) {
                    opt.classList.remove('d-none-custom');
                    hasBooks = true;
                } else {
                    opt.classList.add('d-none-custom');
                }
            });

            if (!hasBooks) {
                bookSelect.innerHTML = '<option value="" disabled selected>ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                bookSelect.disabled = true;
            } else {
                const defaultOpt = document.createElement('option');
                defaultOpt.text = "-- ì„ íƒí•˜ì„¸ìš” --";
                defaultOpt.value = "";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                if(bookSelect.options[0].text !== defaultOpt.text) bookSelect.prepend(defaultOpt);
            }
        }

        function selectMode(mode, cardElement) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => {
                el.classList.remove('selected');
                el.style.backgroundColor = '';
            });
            cardElement.classList.add('selected');
            if (mode === 'wrong') cardElement.style.backgroundColor = '#fff5f5';

            const btn = document.getElementById('startBtn');
            btn.disabled = false;
            
            const modeNames = {
                'learning': 'ğŸ“– í•™ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'practice': 'ğŸš€ ì—°ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'challenge': 'ğŸ”¥ ë„ì „ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'wrong': 'ğŸš¨ ì˜¤ë‹µ íƒˆì¶œ ì‹œì‘í•˜ê¸°',
                'monthly': 'ğŸ“… ì›”ë§ í‰ê°€ ì‹œì‘í•˜ê¸°'
            };
            btn.innerText = modeNames[mode];
            
            if (mode === 'challenge' || mode === 'wrong') btn.className = 'btn btn-start bg-danger';
            else if (mode === 'learning') btn.className = 'btn btn-start bg-success';
            else if (mode === 'monthly') btn.className = 'btn btn-start bg-warning';
            else btn.className = 'btn btn-start bg-primary';
        }

        function startExam() {
            if (!selectedMode) return alert("ì‹œí—˜ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if (selectedMode === 'wrong') {
                window.location.href = "{% url 'vocab:wrong_study' %}";
                return;
            }

            const bookId = document.getElementById('bookSelect').value;
            const range = document.getElementById('rangeInput').value.trim();

            if (!bookId) {
                alert("ë‹¨ì–´ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                document.getElementById('bookSelect').focus();
                return;
            }

            if (selectedMode === 'monthly') {
                const msg = "âš ï¸ [ì¤‘ìš”] ì›”ë§ í‰ê°€ëŠ” ë‹¨ 1ë²ˆë§Œ ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
                            "ì‘ì‹œ ë„ì¤‘ 'ë’¤ë¡œê°€ê¸°'ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì°½ì„ ë‹«ìœ¼ë©´\n" +
                            "ì‹œí—˜ì´ ì¢…ë£Œë˜ì–´ ì¬ì‘ì‹œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n" +
                            "ì •ë§ë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                
                if (confirm(msg)) {
                    let url = `{% url 'vocab:exam' %}?mode=monthly&book_id=${bookId}`;
                    if (range) url += `&day_range=${encodeURIComponent(range)}`;
                    window.location.href = url;
                }
                return; 
            }

            let url = `/vocab/exam/?book_id=${bookId}&mode=${selectedMode}`;
            if (range) url += `&day_range=${encodeURIComponent(range)}`;
            window.location.href = url;
        }

        // íŒì—… ì—´ê¸° í•¨ìˆ˜
        function openHistoryModal(dateStr) {
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            document.getElementById('modalDate').innerText = dateStr;
            document.getElementById('modalContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>`; 
            modal.show();

            fetch(`/vocab/api/history/date/?date=${dateStr}`)
                .then(res => res.json())
                .then(data => {
                    const contentDiv = document.getElementById('modalContent');
                    if (data.status === 'success' && data.exams.length > 0) {
                        let html = `<div class="d-flex flex-column gap-3">`;
                        data.exams.forEach(exam => {
                            let wrongHtml = '';
                            if (exam.wrong_words.length > 0) {
                                wrongHtml = `
                                    <div class="mt-3 p-3 bg-white rounded border border-danger-subtle">
                                        <h6 class="text-danger fw-bold border-bottom pb-2 mb-2" style="font-size: 0.9rem;">
                                            <i class="bi bi-x-circle me-1"></i> í‹€ë¦° ë‹¨ì–´ (${exam.wrong_words.length}ê°œ)
                                        </h6>
                                        <ul class="list-unstyled mb-0 row">
                                            ${exam.wrong_words.map(w => `
                                                <li class="col-6 mb-1 text-secondary" style="font-size: 0.9rem;">
                                                    <span class="fw-bold text-dark">${w.word}</span> : ${w.answer}
                                                </li>`).join('')}
                                        </ul>
                                    </div>`;
                            } else {
                                wrongHtml = `<div class="mt-3 text-success small fw-bold"><i class="bi bi-check-circle-fill"></i> ë§Œì ì…ë‹ˆë‹¤! (Perfect)</div>`;
                            }

                            html += `
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="card-title fw-bold mb-0 text-primary">
                                                <i class="bi bi-journal-bookmark-fill me-1"></i> ${exam.book_title}
                                            </h5>
                                            <span class="badge bg-light text-secondary border">${exam.time} ì‘ì‹œ</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="badge bg-primary fs-6">${exam.score} / ${exam.total}ì </span>
                                        </div>
                                        ${wrongHtml}
                                    </div>
                                </div>`;
                        });
                        html += `</div>`;
                        contentDiv.innerHTML = html;
                    } else {
                        contentDiv.innerHTML = `<div class="text-center py-5 text-muted">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('modalContent').innerHTML = `<div class="text-center text-danger py-4">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
                });
        }

        // ì´ˆê¸°í™” ë¡œì§
        document.addEventListener("DOMContentLoaded", function() {
            
            // (1) êº¾ì€ì„  ê·¸ë˜í”„
            const rawLabels = {{ graph_labels|default:"[]"|safe }};
            const rawData = {{ graph_data|default:"[]"|safe }};
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            if(rawLabels.length === 0) {
                document.getElementById('growthChart').style.display = 'none';
                document.querySelector('#growthChart').parentElement.innerHTML = '<div class="text-center text-muted py-5 small">ê¸°ë¡ì´ ìŒ“ì´ë©´<br>ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!</div>';
            } else {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: rawLabels,
                        datasets: [{
                            data: rawData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#0d6efd',
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 30, ticks: { stepSize: 10, display: true }, grid: { drawBorder: false } },
                            x: { grid: { display: false }, ticks: { maxTicksLimit: 5 } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // (2) íˆíŠ¸ë§µ ê·¸ë¦¬ê¸° (v3)
            const heatmapData = {{ heatmap_data|safe|default:"{}" }};
            var cal = new CalHeatMap(); 
            
            const isMobile = window.innerWidth < 576;
            const range = 3; 
            const cellSize = isMobile ? 13 : 16; 

            // ì‹œì‘ì¼ ê³„ì‚° (ì§€ë‚œë‹¬ 1ì¼)
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            cal.init({
                itemSelector: "#cal-heatmap",
                domain: "month",
                subDomain: "day",
                data: heatmapData,
                start: startMonth,
                cellSize: cellSize,
                range: range,      
                cellPadding: 3,    
                domainGutter: 15,  
                tooltip: true,
                legend: [1, 3, 5, 10],
                onClick: function(date, nb) {
                    if (nb === 0) return; 
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    openHistoryModal(dateStr);
                }
            });
        });
    </script>
</body>
</html>