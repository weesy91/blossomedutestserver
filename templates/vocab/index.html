<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ì„¤ì • - Blossom Edu</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .config-container {
            max-width: 700px; 
            margin: 0 auto 40px auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .nav-pills .nav-link {
            border-radius: 12px;
            padding: 12px;
            color: #495057;
            background-color: #f1f3f5;
            margin: 0 5px;
            font-weight: 700;
            transition: all 0.2s;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef;
        }

        /* ë­í‚¹ ì¹´ë“œ íƒ­ ìŠ¤íƒ€ì¼ */
        .card-header-pills .nav-link {
            border-radius: 20px;
            font-size: 0.85rem;
            padding: 6px 16px;
        }

        /* íˆíŠ¸ë§µ ì»¨í…Œì´ë„ˆ */
        #cal-heatmap-container {
            width: 100%;
            overflow-x: auto;
            padding-top: 50px; /* íˆ´íŒ ì˜ë¦¼ ë°©ì§€ìš© ì—¬ë°± */
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            scrollbar-width: thin;
        }

        @media (max-width: 576px) {
            .config-container { padding: 20px; }
            .header-bar h4 { font-size: 1.2rem; }
            .nav-pills .nav-link { font-size: 0.9rem; padding: 10px; }
        }

        .section-label {
            font-weight: 700;
            font-size: 1rem;
            color: #343a40;
            margin-bottom: 8px;
        }
        .form-select, .form-control {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            font-size: 0.95rem;
        }
        .form-select:focus, .form-control:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 4px rgba(77, 171, 247, 0.1);
        }
        .mode-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }
        .mode-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mode-card.selected { border-color: #0d6efd; background-color: #f8f9fa; }
        .mode-icon { font-size: 1.4rem; margin-right: 12px; width: 30px; text-align: center; }
        .mode-title { font-weight: 800; font-size: 1rem; margin-bottom: 1px; }
        .mode-desc { font-size: 0.8rem; color: #868e96; margin: 0; }
        .btn-start {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            margin-top: 15px;
            background-color: #0d6efd;
            border: none;
            color: white;
        }
        .btn-start:hover { background-color: #0b5ed7; color: white; }
        .btn-start:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-bar">
            <div class="d-flex align-items-center gap-2">
                <a href="{% url 'core:student_home' %}" class="btn btn-light text-secondary border-0 p-1" title="ë©”ì¸ í™ˆìœ¼ë¡œ">
                    <i class="bi bi-arrow-left-circle fs-4"></i>
                </a>
                <h4 class="fw-bold m-0 text-primary">ğŸ“ ì‹œí—˜ ì„¤ì •</h4>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3" style="max-width: 700px; margin: 0 auto;">
            <a href="{% url 'vocab:wrong_word_list' %}" class="btn btn-outline-danger shadow-sm fw-bold">
                <i class="bi bi-journal-bookmark-fill me-1"></i> ì˜¤ë‹µ ëª©ë¡
            </a>
            <a href="{% url 'vocab:search_word_page' %}" class="btn btn-outline-primary shadow-sm fw-bold">
                <i class="bi bi-search me-1"></i> ë‹¨ì–´ ê²€ìƒ‰ & ì˜¤ë‹µ ì¶”ê°€
            </a>
        </div>

        <div class="config-container">
            
            <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-status-tab" data-bs-toggle="pill" data-bs-target="#pills-status" type="button" role="tab">
                        ğŸ“Š ë‚´ í•™ìŠµ í˜„í™©
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-learning-tab" data-bs-toggle="pill" data-bs-target="#pills-learning" type="button" role="tab">
                        ğŸ“ ë‹¨ì–´ í•™ìŠµí•˜ê¸°
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-status" role="tabpanel">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm border bg-white">
                                <div class="card-header bg-transparent border-0 pt-3 px-3">
                                    <ul class="nav nav-pills card-header-pills" id="rankingTabs" role="tablist">
                                        
                                        {% if event_list|length > 1 %}
                                            <li class="nav-item dropdown">
                                                <a class="nav-link dropdown-toggle {% if event_list %}active{% endif %} fw-bold" 
                                                   data-bs-toggle="dropdown" 
                                                   href="#" 
                                                   role="button" 
                                                   aria-expanded="false">
                                                    ğŸ† ì´ë²¤íŠ¸
                                                </a>
                                                <ul class="dropdown-menu shadow border-0">
                                                    {% for item in event_list %}
                                                    <li>
                                                        <a class="dropdown-item small fw-bold {% if forloop.first %}active{% endif %}" 
                                                           data-bs-toggle="tab" 
                                                           data-bs-target="#event-{{ item.info.id }}" 
                                                           type="button">
                                                            {{ item.info.title }}
                                                        </a>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                        {% else %}
                                            <li class="nav-item">
                                                {% if event_list %}
                                                    <button class="nav-link active fw-bold" 
                                                            id="event-single-tab" 
                                                            data-bs-toggle="tab" 
                                                            data-bs-target="#event-{{ event_list.0.info.id }}" 
                                                            type="button">
                                                        ğŸ† ì´ë²¤íŠ¸
                                                    </button>
                                                {% else %}
                                                    <button class="nav-link fw-bold" 
                                                            id="event-empty-tab" 
                                                            data-bs-toggle="tab" 
                                                            data-bs-target="#event-empty" 
                                                            type="button">
                                                        ğŸ† ì´ë²¤íŠ¸
                                                    </button>
                                                {% endif %}
                                            </li>
                                        {% endif %}

                                        <li class="nav-item ms-1">
                                            <button class="nav-link {% if not event_list %}active{% endif %} fw-bold" 
                                                    id="month-rank-tab" 
                                                    data-bs-toggle="tab" 
                                                    data-bs-target="#month-rank" 
                                                    type="button">
                                                ğŸ”¥ ì´ë‹¬ì˜ ì™•
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                                <div class="card-body p-3 pt-2">
                                    <div class="tab-content" id="rankingTabContent">
                                        
                                        {% if event_list %}
                                            {% for item in event_list %}
                                            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                                                 id="event-{{ item.info.id }}" 
                                                 role="tabpanel">
                                                
                                                <div class="alert alert-warning py-2 px-3 mb-3 border-warning" style="background-color: #fffbf0;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong class="d-block text-dark mb-1" style="font-size: 0.9rem;">
                                                                {{ item.info.title }}
                                                            </strong>
                                                            <span class="text-muted small">
                                                                <i class="bi bi-book me-1"></i>ëŒ€ìƒ: {{ item.info.target_book.title }}
                                                            </span>
                                                        </div>
                                                        <span class="badge bg-warning text-dark border border-warning">ì§„í–‰ì¤‘</span>
                                                    </div>
                                                </div>

                                                <ul class="list-group list-group-flush small">
                                                    {% for ranker in item.rankings %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-1 py-2">
                                                        <div class="d-flex align-items-center">
                                                            {% if ranker.rank == 1 %}
                                                                <span class="fs-5 me-2">ğŸ¥‡</span>
                                                            {% elif ranker.rank == 2 %}
                                                                <span class="fs-5 me-2">ğŸ¥ˆ</span>
                                                            {% elif ranker.rank == 3 %}
                                                                <span class="fs-5 me-2">ğŸ¥‰</span>
                                                            {% else %}
                                                                <span class="badge bg-light text-dark border me-2" style="width: 24px;">{{ ranker.rank }}</span>
                                                            {% endif %}
                                                            <span class="fw-bold">{{ ranker.name }}</span>
                                                        </div>
                                                        <span class="text-danger fw-bold">{{ ranker.score }} ì </span>
                                                    </li>
                                                    {% empty %}
                                                    <li class="text-center text-muted py-4 small">
                                                        ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.<br>1ë“±ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸƒâ€â™‚ï¸
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endfor %}
                                        
                                        {% else %}
                                            <div class="tab-pane fade" id="event-empty" role="tabpanel">
                                                <div class="text-center py-5 text-muted small">
                                                    <i class="bi bi-gift fs-1 mb-2 d-block opacity-50"></i>
                                                    í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ ê¸°ëŒ€í•´ì£¼ì„¸ìš”! ğŸ
                                                </div>
                                            </div>
                                        {% endif %}

                                        <div class="tab-pane fade {% if not event_list %}show active{% endif %}" id="month-rank" role="tabpanel">
                                            <div class="mb-3 text-secondary small fw-bold ps-1">
                                                ğŸ“… ì´ë²ˆ ë‹¬ ëˆ„ì  ì ìˆ˜ TOP 5
                                            </div>
                                            <ul class="list-group list-group-flush small">
                                                {% for ranker in monthly_ranking %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-1 py-2">
                                                    <div>
                                                        {% if ranker.rank == 1 %}ğŸ¥‡{% elif ranker.rank == 2 %}ğŸ¥ˆ{% elif ranker.rank == 3 %}ğŸ¥‰{% else %}<span class="badge bg-light text-dark border ms-1">{{ ranker.rank }}</span>{% endif %}
                                                        <span class="fw-bold ms-2">{{ ranker.name }}</span>
                                                    </div>
                                                    <span class="text-primary fw-bold">{{ ranker.score }} XP</span>
                                                </li>
                                                {% empty %}
                                                <li class="text-center text-muted py-4 small">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm border bg-light">
                                <div class="card-header bg-transparent fw-bold text-primary border-0 pt-3 ps-3">
                                    ğŸ“ˆ ë‚˜ì˜ ì‹¤ë ¥ ë³€í™”
                                </div>
                                <div class="card-body p-2 pt-0" style="height: 150px;">
                                    <canvas id="growthChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border mb-4">
                        <div class="card-header bg-white fw-bold py-2 border-bottom-0">
                            ğŸŒ± í•™ìŠµ ì”ë”” (Study Heatmap)
                            <small class="text-muted fw-normal ms-2" style="font-size: 0.8rem;">ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì„ ë§Œë“­ë‹ˆë‹¤!</small>
                        </div>
                        <div class="card-body pt-0 pb-3">
                            <div id="cal-heatmap-container">
                                <div id="cal-heatmap"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-learning" role="tabpanel">
                    <div class="alert alert-primary d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                        <div class="small">
                            ì˜¤ëŠ˜ë„ í™”ì´íŒ…! <strong>{{ user.profile.name }}</strong> í•™ìƒì˜ ì—´ì •ì„ ì‘ì›í•©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <div class="section-label">1. ì¶œíŒì‚¬ ì„ íƒ</div>
                            <select id="publisherSelect" class="form-select mb-3" onchange="filterBooks()">
                                <option value="" selected disabled>-- ì„ íƒí•˜ì„¸ìš” --</option>
                                {% for pub in publishers %}
                                    <option value="{{ pub.id }}">{{ pub.name }}</option>
                                {% endfor %}
                                {% if etc_books %}
                                    <option value="etc">ê¸°íƒ€</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <div class="section-label">2. ë‹¨ì–´ì¥ ì„ íƒ</div>
                            <select id="bookSelect" class="form-select mb-3" disabled>
                                <option value="" selected disabled>-- ì¶œíŒì‚¬ ë¨¼ì € --</option>
                                {% for pub in publishers %}
                                    {% for book in pub.wordbook_set.all %}
                                        <option value="{{ book.id }}" data-publisher="{{ pub.id }}">
                                            {{ book.title }}
                                        </option>
                                    {% endfor %}
                                {% endfor %}
                                {% for book in etc_books %}
                                    <option value="{{ book.id }}" data-publisher="etc">
                                        {{ book.title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="section-label">3. Day ë²”ìœ„ ì„¤ì •</div>
                        <input type="text" id="rangeInput" class="form-control" placeholder="ì˜ˆ: 1-5, 7 (ë¹„ì›Œë‘ë©´ ì „ì²´)">
                    </div>

                    <div>
                        <div class="section-label">4. ì‹œí—˜ ëª¨ë“œ ì„ íƒ</div>
                        
                        <div class="mode-card" onclick="selectMode('learning', this)">
                            <div class="mode-icon">ğŸ“–</div>
                            <div>
                                <div class="mode-title text-primary">í•™ìŠµ ëª¨ë“œ</div>
                                <p class="mode-desc">ì •ë‹µê³¼ ì˜ˆë¬¸ì„ ë³´ë©° ì•”ê¸°</p>
                            </div>
                        </div>

                        <div class="mode-card" onclick="selectMode('practice', this)">
                            <div class="mode-icon">ğŸŒ±</div>
                            <div>
                                <div class="mode-title text-success">ì—°ìŠµ ëª¨ë“œ</div>
                                <p class="mode-desc">ê¸°ë¡ ë‚¨ì§€ ì•ŠìŒ (ì„ íƒ ì „ë²”ìœ„)</p>
                            </div>
                        </div>

                        {% if is_wrong_mode_active %}
                            <div class="mode-card" onclick="selectMode('wrong', this)" style="border-color: #ff6b6b; background-color: #fff5f5;">
                                <div class="mode-icon">ğŸš¨</div>
                                <div>
                                    <div class="mode-title text-danger">ì˜¤ë‹µ íƒˆì¶œ ëª¨ë“œ</div>
                                    <p class="mode-desc text-danger">ì·¨ì•½ ë‹¨ì–´ <strong>{{ wrong_count }}ê°œ</strong>ê°€ ìŒ“ì˜€ìŠµë‹ˆë‹¤!</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="mode-card" onclick="selectMode('challenge', this)">
                                <div class="mode-icon">ğŸ”¥</div>
                                <div>
                                    <div class="mode-title text-danger">ë„ì „ ëª¨ë“œ (ì‹œí—˜)</div>
                                    <p class="mode-desc">ê²°ê³¼ ì €ì¥ + ë¶ˆí•©ê²© ì‹œ ì¿¨íƒ€ì„</p>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if is_monthly_period %}
                        <div class="mode-card" onclick="selectMode('monthly', this)" style="border-color: #ffc107; background-color: #fff9db;">
                                <div class="mode-icon">ğŸ“…</div>
                                <div>
                                    <div class="mode-title" style="color: #d68c00;">ì›”ë§ í‰ê°€</div>
                                    <p class="mode-desc">ì´ë²ˆ ë‹¬ í•™ìŠµ ë‚´ìš© ìµœì¢… ì ê²€ (100ë¬¸ì œ)</p>
                                </div>
                            </div>
                    {% endif %}
                    </div>

                    <button id="startBtn" class="btn btn-start" onclick="startExam()" disabled>
                        ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span id="modalDate"></span> í•™ìŠµ ê¸°ë¡
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light" id="modalContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜
        let selectedMode = null;
        
        // [ì¶”ê°€] í˜ì´ì§€ ë¡œë”© ì‹œì ì— ëª¨ë“  ë‹¨ì–´ì¥ ì˜µì…˜ì„ ë°±ì—…í•´ë‘¡ë‹ˆë‹¤.
        const originalBookSelect = document.getElementById('bookSelect');
        // ì²« ë²ˆì§¸ ì˜µì…˜('-- ì¶œíŒì‚¬ ë¨¼ì € --')ì„ ì œì™¸í•˜ê³  ë°ì´í„°ê°€ ìˆëŠ” ì˜µì…˜ë“¤ë§Œ ì €ì¥
        const allBookOptions = Array.from(originalBookSelect.querySelectorAll('option')).filter(opt => opt.value !== "");

        // [ìˆ˜ì •] ë‹¨ì–´ì¥ í•„í„°ë§ í•¨ìˆ˜ (ìˆ¨ê¸°ëŠ” ê²Œ ì•„ë‹ˆë¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ë°©ì‹)
        function filterBooks() {
            const pubSelect = document.getElementById('publisherSelect');
            const bookSelect = document.getElementById('bookSelect');
            const selectedPubId = pubSelect.value;

            // 1. ê¸°ì¡´ ëª©ë¡ ì‹¹ ë¹„ìš°ê¸°
            bookSelect.innerHTML = '';
            bookSelect.disabled = false;

            // 2. ê¸°ë³¸ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
            const defaultOpt = document.createElement('option');
            defaultOpt.text = "-- ì„ íƒí•˜ì„¸ìš” --";
            defaultOpt.value = "";
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            bookSelect.appendChild(defaultOpt);

            // 3. ë°±ì—…í•´ë‘” ëª©ë¡ ì¤‘ì—ì„œ ì¶œíŒì‚¬ê°€ ì¼ì¹˜í•˜ëŠ” ê²ƒë§Œ ë‹¤ì‹œ ì¶”ê°€
            let hasBooks = false;
            allBookOptions.forEach(opt => {
                // HTMLì—ì„œ ì„¤ì •í•œ data-publisher ê°’ì„ ê°€ì ¸ì˜´
                const bookPubId = opt.getAttribute('data-publisher');

                if (bookPubId === selectedPubId) {
                    // ì˜µì…˜ì„ ë³µì‚¬í•´ì„œ ì¶”ê°€ (ê·¸ëƒ¥ ì¶”ê°€í•˜ë©´ ì›ë³¸ ë°°ì—´ì—ì„œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŒ)
                    bookSelect.appendChild(opt.cloneNode(true));
                    hasBooks = true;
                }
            });

            // 4. ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
            if (!hasBooks) {
                bookSelect.innerHTML = '<option value="" disabled selected>ğŸš« í•´ë‹¹ ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                bookSelect.disabled = true;
            }
        }

        function selectMode(mode, cardElement) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => {
                el.classList.remove('selected');
                el.style.backgroundColor = '';
            });
            cardElement.classList.add('selected');
            if (mode === 'wrong') cardElement.style.backgroundColor = '#fff5f5';

            const btn = document.getElementById('startBtn');
            btn.disabled = false;
            
            const modeNames = {
                'learning': 'ğŸ“– í•™ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'practice': 'ğŸš€ ì—°ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'challenge': 'ğŸ”¥ ë„ì „ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'wrong': 'ğŸš¨ ì˜¤ë‹µ íƒˆì¶œ ì‹œì‘í•˜ê¸°',
                'monthly': 'ğŸ“… ì›”ë§ í‰ê°€ ì‹œì‘í•˜ê¸°'
            };
            btn.innerText = modeNames[mode];
            
            if (mode === 'challenge' || mode === 'wrong') btn.className = 'btn btn-start bg-danger';
            else if (mode === 'learning') btn.className = 'btn btn-start bg-success';
            else if (mode === 'monthly') btn.className = 'btn btn-start bg-warning';
            else btn.className = 'btn btn-start bg-primary';
        }

        function startExam() {
            if (!selectedMode) return alert("ì‹œí—˜ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if (selectedMode === 'wrong') {
                window.location.href = "{% url 'vocab:wrong_study' %}";
                return;
            }

            const bookId = document.getElementById('bookSelect').value;
            const range = document.getElementById('rangeInput').value.trim();

            if (!bookId) {
                alert("ë‹¨ì–´ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                document.getElementById('bookSelect').focus();
                return;
            }

            if (selectedMode === 'monthly') {
                const msg = "âš ï¸ [ì¤‘ìš”] ì›”ë§ í‰ê°€ëŠ” ë‹¨ 1ë²ˆë§Œ ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
                            "ì‘ì‹œ ë„ì¤‘ 'ë’¤ë¡œê°€ê¸°'ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì°½ì„ ë‹«ìœ¼ë©´\n" +
                            "ì‹œí—˜ì´ ì¢…ë£Œë˜ì–´ ì¬ì‘ì‹œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n" +
                            "ì •ë§ë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                
                if (confirm(msg)) {
                    let url = `{% url 'vocab:exam' %}?mode=monthly&book_id=${bookId}`;
                    if (range) url += `&day_range=${encodeURIComponent(range)}`;
                    window.location.href = url;
                }
                return; 
            }

            let url = `/vocab/exam/?book_id=${bookId}&mode=${selectedMode}`;
            if (range) url += `&day_range=${encodeURIComponent(range)}`;
            window.location.href = url;
        }

        // íŒì—… ì—´ê¸° í•¨ìˆ˜
        function openHistoryModal(dateStr) {
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            document.getElementById('modalDate').innerText = dateStr;
            document.getElementById('modalContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>`; 
            modal.show();

            fetch(`/vocab/api/history/date/?date=${dateStr}`)
                .then(res => res.json())
                .then(data => {
                    const contentDiv = document.getElementById('modalContent');
                    if (data.status === 'success' && data.exams.length > 0) {
                        let html = `<div class="d-flex flex-column gap-3">`;
                        data.exams.forEach(exam => {
                            let wrongHtml = '';
                            if (exam.wrong_words.length > 0) {
                                wrongHtml = `
                                    <div class="mt-3 p-3 bg-white rounded border border-danger-subtle">
                                        <h6 class="text-danger fw-bold border-bottom pb-2 mb-2" style="font-size: 0.9rem;">
                                            <i class="bi bi-x-circle me-1"></i> í‹€ë¦° ë‹¨ì–´ (${exam.wrong_words.length}ê°œ)
                                        </h6>
                                        <ul class="list-unstyled mb-0 row">
                                            ${exam.wrong_words.map(w => `
                                                <li class="col-6 mb-1 text-secondary" style="font-size: 0.9rem;">
                                                    <span class="fw-bold text-dark">${w.word}</span> : ${w.answer}
                                                </li>`).join('')}
                                        </ul>
                                    </div>`;
                            } else {
                                wrongHtml = `<div class="mt-3 text-success small fw-bold"><i class="bi bi-check-circle-fill"></i> ë§Œì ì…ë‹ˆë‹¤! (Perfect)</div>`;
                            }

                            html += `
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="card-title fw-bold mb-0 text-primary">
                                                <i class="bi bi-journal-bookmark-fill me-1"></i> ${exam.book_title}
                                            </h5>
                                            <span class="badge bg-light text-secondary border">${exam.time} ì‘ì‹œ</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="badge bg-primary fs-6">${exam.score} / ${exam.total}ì </span>
                                        </div>
                                        ${wrongHtml}
                                    </div>
                                </div>`;
                        });
                        html += `</div>`;
                        contentDiv.innerHTML = html;
                    } else {
                        contentDiv.innerHTML = `<div class="text-center py-5 text-muted">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('modalContent').innerHTML = `<div class="text-center text-danger py-4">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
                });
        }

        // ì´ˆê¸°í™” ë¡œì§
        document.addEventListener("DOMContentLoaded", function() {
            
            // (1) êº¾ì€ì„  ê·¸ë˜í”„
            const rawLabels = {{ graph_labels|default:"[]"|safe }};
            const rawData = {{ graph_data|default:"[]"|safe }};
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            if(rawLabels.length === 0) {
                document.getElementById('growthChart').style.display = 'none';
                document.querySelector('#growthChart').parentElement.innerHTML = '<div class="text-center text-muted py-5 small">ê¸°ë¡ì´ ìŒ“ì´ë©´<br>ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!</div>';
            } else {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: rawLabels,
                        datasets: [{
                            data: rawData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#0d6efd',
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 30, ticks: { stepSize: 10, display: true }, grid: { drawBorder: false } },
                            x: { grid: { display: false }, ticks: { maxTicksLimit: 5 } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // (2) íˆíŠ¸ë§µ ê·¸ë¦¬ê¸° (v3)
            const heatmapData = {{ heatmap_data|safe|default:"{}" }};
            var cal = new CalHeatMap(); 
            
            const isMobile = window.innerWidth < 576;
            const range = 3; 
            const cellSize = isMobile ? 13 : 16; 

            // ì‹œì‘ì¼ ê³„ì‚° (ì§€ë‚œë‹¬ 1ì¼)
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            cal.init({
                itemSelector: "#cal-heatmap",
                domain: "month",
                subDomain: "day",
                data: heatmapData,
                start: startMonth,
                cellSize: cellSize,
                range: range,      
                cellPadding: 3,    
                domainGutter: 15,  
                tooltip: true,
                legend: [1, 3, 5, 10],
                onClick: function(date, nb) {
                    if (nb === 0) return; 
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    openHistoryModal(dateStr);
                }
            });
        });
    </script>
</body>
</html>