<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ì„¤ì • - Blossom Edu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .config-container {
            max-width: 700px; 
            margin: 0 auto 40px auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* [NEW] íˆíŠ¸ë§µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #cal-heatmap-container {
            width: 100%;
            overflow-x: auto; /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            padding-bottom: 10px;
        }

        @media (max-width: 576px) {
            .config-container { padding: 20px; }
            .header-bar h4 { font-size: 1.2rem; }
        }

        .section-label {
            font-weight: 700;
            font-size: 1rem;
            color: #343a40;
            margin-bottom: 8px;
        }
        .form-select, .form-control {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            font-size: 0.95rem;
        }
        .form-select:focus, .form-control:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 4px rgba(77, 171, 247, 0.1);
        }
        .mode-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }
        .mode-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mode-card.selected { border-color: #0d6efd; background-color: #f8f9fa; }
        .mode-icon { font-size: 1.4rem; margin-right: 12px; width: 30px; text-align: center; }
        .mode-title { font-weight: 800; font-size: 1rem; margin-bottom: 1px; }
        .mode-desc { font-size: 0.8rem; color: #868e96; margin: 0; }
        .btn-start {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            margin-top: 15px;
            background-color: #0d6efd;
            border: none;
            color: white;
        }
        .btn-start:hover { background-color: #0b5ed7; color: white; }
        .btn-start:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-bar">
            <h4 class="fw-bold m-0 text-primary">ğŸ“ ì‹œí—˜ ì„¤ì •</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="fw-bold text-dark">
                    ğŸ§‘â€ğŸ“ {{ user.profile.name|default:user.username }} í•™ìƒ
                </span>
                <a href="{% url 'core:logout' %}" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                    ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3" style="max-width: 700px; margin: 0 auto;">
            <a href="{% url 'vocab:search_word_page' %}" class="btn btn-outline-primary shadow-sm fw-bold">
                <i class="bi bi-search me-1"></i> ë‹¨ì–´ ê²€ìƒ‰ & ì˜¤ë‹µ ì¶”ê°€
            </a>
        </div>

        <div class="config-container">
            
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border bg-light">
                        <div class="card-header bg-transparent fw-bold text-warning border-0 pt-3 ps-3">
                            ğŸ‘‘ ì´ë‹¬ì˜ ë­í‚¹ TOP 5
                        </div>
                        <div class="card-body p-2 pt-0">
                            <ul class="list-group list-group-flush bg-transparent small">
                                {% for ranker in ranking_list %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-2 bg-transparent">
                                    <span>
                                        <span class="badge rounded-pill bg-warning text-dark me-2">{{ ranker.rank }}ìœ„</span>
                                        <span class="fw-bold">{{ ranker.name }}</span>
                                    </span>
                                    <span class="text-muted fw-bold">{{ ranker.count }} XP</span>
                                </li>
                                {% empty %}
                                <li class="list-group-item text-center text-muted small py-3 bg-transparent">ì•„ì§ ë­í‚¹ ì£¼ì¸ê³µì´ ì—†ì–´ìš”!</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
        
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border bg-light">
                        <div class="card-header bg-transparent fw-bold text-primary border-0 pt-3 ps-3">
                            ğŸ“ˆ ë‚˜ì˜ ì‹¤ë ¥ ë³€í™”
                        </div>
                        <div class="card-body p-2 pt-0" style="height: 150px;">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border mb-4">
                <div class="card-header bg-white fw-bold py-2 border-bottom-0">
                    ğŸŒ± í•™ìŠµ ì”ë”” (Study Heatmap)
                    <small class="text-muted fw-normal ms-2" style="font-size: 0.8rem;">ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì„ ë§Œë“­ë‹ˆë‹¤!</small>
                </div>
                <div class="card-body pt-0 pb-3">
                    <div id="cal-heatmap-container">
                        <div id="cal-heatmap"></div>
                    </div>
                </div>
            </div>
            
            <hr class="border-secondary-subtle my-4 opacity-50">

            <div class="row g-3 mb-2">
                <div class="col-md-6">
                    <div class="section-label">1. ì¶œíŒì‚¬ ì„ íƒ</div>
                    <select id="publisherSelect" class="form-select mb-3" onchange="filterBooks()">
                        <option value="" selected disabled>-- ì„ íƒí•˜ì„¸ìš” --</option>
                        {% for pub in publishers %}
                            <option value="{{ pub.id }}">{{ pub.name }}</option>
                        {% endfor %}
                        {% if etc_books %}
                            <option value="etc">ê¸°íƒ€</option>
                        {% endif %}
                    </select>
                </div>

                <div class="col-md-6">
                    <div class="section-label">2. ë‹¨ì–´ì¥ ì„ íƒ</div>
                    <select id="bookSelect" class="form-select mb-3" disabled>
                        <option value="" selected disabled>-- ì¶œíŒì‚¬ ë¨¼ì € --</option>
                        {% for pub in publishers %}
                            {% for book in pub.wordbook_set.all %}
                            <option value="{{ book.id }}" class="book-option pub-{{ pub.id }} d-none-custom">{{ book.title }}</option>
                            {% endfor %}
                        {% endfor %}
                        {% for book in etc_books %}
                        <option value="{{ book.id }}" class="book-option pub-etc d-none-custom">{{ book.title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <div class="section-label">3. Day ë²”ìœ„ ì„¤ì •</div>
                <input type="tel" id="rangeInput" class="form-control" placeholder="ì˜ˆ: 1-5, 7 (ë¹„ì›Œë‘ë©´ ì „ì²´)">
            </div>

            <div>
                <div class="section-label">4. ì‹œí—˜ ëª¨ë“œ ì„ íƒ</div>
                
                <div class="mode-card" onclick="selectMode('learning', this)">
                    <div class="mode-icon">ğŸ“–</div>
                    <div>
                        <div class="mode-title text-primary">í•™ìŠµ ëª¨ë“œ</div>
                        <p class="mode-desc">ì •ë‹µê³¼ ì˜ˆë¬¸ì„ ë³´ë©° ì•”ê¸°</p>
                    </div>
                </div>

                <div class="mode-card" onclick="selectMode('practice', this)">
                    <div class="mode-icon">ğŸŒ±</div>
                    <div>
                        <div class="mode-title text-success">ì—°ìŠµ ëª¨ë“œ</div>
                        <p class="mode-desc">ê¸°ë¡ ë‚¨ì§€ ì•ŠìŒ (30ë¬¸ì œ)</p>
                    </div>
                </div>

                {% if is_wrong_mode_active %}
                    <div class="mode-card" onclick="selectMode('wrong', this)" style="border-color: #ff6b6b; background-color: #fff5f5;">
                        <div class="mode-icon">ğŸš¨</div>
                        <div>
                            <div class="mode-title text-danger">ì˜¤ë‹µ íƒˆì¶œ ëª¨ë“œ</div>
                            <p class="mode-desc text-danger">ì·¨ì•½ ë‹¨ì–´ <strong>{{ wrong_count }}ê°œ</strong>ê°€ ìŒ“ì˜€ìŠµë‹ˆë‹¤!</p>
                        </div>
                    </div>
                {% else %}
                    <div class="mode-card" onclick="selectMode('challenge', this)">
                        <div class="mode-icon">ğŸ”¥</div>
                        <div>
                            <div class="mode-title text-danger">ë„ì „ ëª¨ë“œ (ì‹œí—˜)</div>
                            <p class="mode-desc">ê²°ê³¼ ì €ì¥ + ë¶ˆí•©ê²© ì‹œ ì¿¨íƒ€ì„</p>
                        </div>
                    </div>
                {% endif %}
                
                {% if is_monthly_period %}
                <div class="mode-card" onclick="selectMode('monthly', this)" style="border-color: #ffc107; background-color: #fff9db;">
                        <div class="mode-icon">ğŸ“…</div>
                        <div>
                            <div class="mode-title" style="color: #d68c00;">ì›”ë§ í‰ê°€</div>
                            <p class="mode-desc">ì´ë²ˆ ë‹¬ í•™ìŠµ ë‚´ìš© ìµœì¢… ì ê²€ (100ë¬¸ì œ)</p>
                        </div>
                    </div>
            {% endif %}
            </div>

            <button id="startBtn" class="btn btn-start" onclick="startExam()" disabled>
                ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
            </button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // [ê¸°ì¡´] êº¾ì€ì„  ê·¸ë˜í”„
            const rawLabels = {{ graph_labels|default:"[]"|safe }};
            const rawData = {{ graph_data|default:"[]"|safe }};
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            if(rawLabels.length === 0) {
                document.getElementById('growthChart').style.display = 'none';
                document.querySelector('#growthChart').parentElement.innerHTML = '<div class="text-center text-muted py-5 small">ê¸°ë¡ì´ ìŒ“ì´ë©´<br>ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!</div>';
            } else {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: rawLabels,
                        datasets: [{
                            data: rawData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#0d6efd',
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 30, ticks: { stepSize: 10, display: true }, grid: { drawBorder: false } },
                            x: { grid: { display: false }, ticks: { maxTicksLimit: 5 } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // [NEW] íˆíŠ¸ë§µ ê·¸ë¦¬ê¸°
            const heatmapData = {{ heatmap_data|safe|default:"{}" }};
            const cal = new CalHeatmap();
            
            // ë°˜ì‘í˜• ë„ˆë¹„ ê³„ì‚° (ëª¨ë°”ì¼ ëŒ€ì‘)
            const isMobile = window.innerWidth < 576;
            const range = isMobile ? 6 : 10; // ëª¨ë°”ì¼ì€ 6ê°œì›”, PCëŠ” 10ê°œì›”
            const cellSize = isMobile ? 12 : 15;

            cal.paint({
                itemSelector: "#cal-heatmap",
                domain: {
                    type: "month",
                    gutter: 10,
                    label: { text: "MMM", position: "top" },
                },
                subDomain: {
                    type: "day",
                    radius: 2,
                    width: cellSize,
                    height: cellSize,
                    gutter: 2
                },
                range: range,
                date: { start: new Date(new Date().setMonth(new Date().getMonth() - (range - 1))) },
                data: {
                    source: heatmapData,
                    type: "json",
                    x: "date", // timestamp (í‚¤)
                    y: "value", // count (ê°’)
                    groupY: 'max'
                },
                scale: {
                    color: {
                        // GitHub ìŠ¤íƒ€ì¼ ìƒ‰ìƒ (ì—°í•œ íšŒìƒ‰ -> ì§„í•œ ì´ˆë¡)
                        range: ["#ebedf0", "#9be9a8", "#40c463", "#30a14e", "#216e39"],
                        type: "threshold",
                        domain: [1, 3, 5, 10]
                    },
                },
            });
        });

        let selectedMode = null;

        function filterBooks() {
            const pubSelect = document.getElementById('publisherSelect');
            const bookSelect = document.getElementById('bookSelect');
            const selectedPubId = pubSelect.value;
            const options = document.querySelectorAll('.book-option');

            bookSelect.value = "";
            bookSelect.disabled = false;
            
            let hasBooks = false;
            options.forEach(opt => {
                if (opt.classList.contains('pub-' + selectedPubId)) {
                    opt.classList.remove('d-none-custom');
                    hasBooks = true;
                } else {
                    opt.classList.add('d-none-custom');
                }
            });

            if (!hasBooks) {
                bookSelect.innerHTML = '<option value="" disabled selected>ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                bookSelect.disabled = true;
            } else {
                const defaultOpt = document.createElement('option');
                defaultOpt.text = "-- ì„ íƒí•˜ì„¸ìš” --";
                defaultOpt.value = "";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                if(bookSelect.options[0].text !== defaultOpt.text) bookSelect.prepend(defaultOpt);
            }
        }

        function selectMode(mode, cardElement) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => {
                el.classList.remove('selected');
                el.style.backgroundColor = '';
            });
            cardElement.classList.add('selected');
            if (mode === 'wrong') cardElement.style.backgroundColor = '#fff5f5';

            const btn = document.getElementById('startBtn');
            btn.disabled = false;
            
            const modeNames = {
                'learning': 'ğŸ“– í•™ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'practice': 'ğŸš€ ì—°ìŠµ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'challenge': 'ğŸ”¥ ë„ì „ ëª¨ë“œ ì‹œì‘í•˜ê¸°',
                'wrong': 'ğŸš¨ ì˜¤ë‹µ íƒˆì¶œ ì‹œì‘í•˜ê¸°',
                'monthly': 'ğŸ“… ì›”ë§ í‰ê°€ ì‹œì‘í•˜ê¸°'
            };
            btn.innerText = modeNames[mode];
            
            if (mode === 'challenge' || mode === 'wrong') btn.className = 'btn btn-start bg-danger';
            else if (mode === 'learning') btn.className = 'btn btn-start bg-success';
            else if (mode === 'monthly') btn.className = 'btn btn-start bg-warning';
            else btn.className = 'btn btn-start bg-primary';
        }

        function startExam() {
            if (!selectedMode) return alert("ì‹œí—˜ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if (selectedMode === 'wrong') {
                window.location.href = "{% url 'vocab:wrong_study' %}";
                return;
            }

            const bookId = document.getElementById('bookSelect').value;
            const range = document.getElementById('rangeInput').value.trim();

            if (!bookId) {
                alert("ë‹¨ì–´ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                document.getElementById('bookSelect').focus();
                return;
            }

            if (selectedMode === 'monthly') {
                const msg = "âš ï¸ [ì¤‘ìš”] ì›”ë§ í‰ê°€ëŠ” ë‹¨ 1ë²ˆë§Œ ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
                            "ì‘ì‹œ ë„ì¤‘ 'ë’¤ë¡œê°€ê¸°'ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì°½ì„ ë‹«ìœ¼ë©´\n" +
                            "ì‹œí—˜ì´ ì¢…ë£Œë˜ì–´ ì¬ì‘ì‹œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n" +
                            "ì •ë§ë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                
                if (confirm(msg)) {
                    let url = `{% url 'vocab:exam' %}?mode=monthly&book_id=${bookId}`;
                    if (range) url += `&day_range=${encodeURIComponent(range)}`;
                    window.location.href = url;
                }
                return; 
            }

            let url = `/vocab/exam/?book_id=${bookId}&mode=${selectedMode}`;
            if (range) url += `&day_range=${encodeURIComponent(range)}`;
            window.location.href = url;
        }
    </script>
</body>
</html>