<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¼ì§€ ì‘ì„±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; }
        .app-container { max-width: 600px; margin: 0 auto; background-color: white; min-height: 100vh; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: #6c757d; margin-bottom: 10px; margin-top: 20px;}
        .form-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 3px; }
        .card-entry { background-color: #f8f9fa; border: none; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .remove-btn { position: absolute; top: 10px; right: 10px; z-index: 10; font-size: 1.2rem; color: #adb5bd; cursor: pointer; line-height: 1; }
        .remove-btn:hover { color: #dc3545; }
        .reading-test-card { border-left: 4px solid #ffc107; background-color: #fffbf0; }
        
        /* ì•„ì½”ë””ì–¸(í´ë”©) ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .info-btn { 
            width: 100%; text-align: left; font-weight: bold; font-size: 0.9rem; 
            padding: 10px 15px; border-radius: 8px; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-my-hw { color: #0d6efd; background-color: #e7f1ff; border: 1px solid #b6d4fe; }
        .btn-other-log { color: #495057; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        
        /* ë‚´ìš© ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-content { 
            background-color: white; border: 1px solid #dee2e6; border-top: none; 
            border-radius: 0 0 8px 8px; padding: 15px; margin-bottom: 15px; margin-top: -5px;
        }
    </style>
</head>
<body>

<div class="app-container shadow-sm">
    <div class="px-3 py-3 border-bottom d-flex align-items-center justify-content-between sticky-top bg-white" style="z-index: 1020;">
        <a href="javascript:history.back()" class="btn btn-sm btn-light">âŒ ì·¨ì†Œ</a>
        <h5 class="m-0 fw-bold">{{ student.name }} <span class="text-primary small">({{ subject }})</span></h5>
        <button type="submit" form="logForm" class="btn btn-sm btn-primary px-3">ğŸ’¾ ì €ì¥</button>
    </div>

    <div class="p-3">
        
        <button class="btn info-btn btn-my-hw" type="button" data-bs-toggle="collapse" data-bs-target="#homeworkCollapse" aria-expanded="true">
            <span><i class="bi bi-clipboard-check me-2"></i>ì§€ë‚œ ì‹œê°„ ë‚´ì¤€ ìˆ™ì œ í™•ì¸</span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse show" id="homeworkCollapse">
            <div class="info-content border-primary border-opacity-25 bg-primary bg-opacity-10">
                {% if my_prev_log %}
                    <div class="d-flex justify-content-between text-muted small mb-2 border-bottom border-primary border-opacity-25 pb-1">
                        <span>ìˆ˜ì—…ì¼: {{ my_prev_log.date|date:"m/d (D)" }}</span>
                    </div>
                    
                    {% if my_prev_log.hw_vocab_range %}
                        <div class="mb-1"><span class="badge bg-danger">ë‹¨ì–´</span> {{ my_prev_log.hw_vocab_range }}</div>
                    {% endif %}
                    
                    {% if my_prev_log.hw_main_range %}
                        <div class="mb-1"><span class="badge bg-primary">êµì¬</span> {{ my_prev_log.hw_main_range }}</div>
                    {% endif %}

                    {% if not my_prev_log.hw_vocab_range and not my_prev_log.hw_main_range %}
                        <div class="text-muted small">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% endif %}

                    {% if my_prev_log.teacher_comment %}
                        <div class="mt-2 pt-2 border-top border-primary border-opacity-25 text-dark small fst-italic">
                            <i class="bi bi-chat-quote me-1"></i> {{ my_prev_log.teacher_comment }}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted small text-center">ì§€ë‚œ ìˆ˜ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}
            </div>
        </div>

        <button class="btn info-btn btn-other-log collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherLogCollapse" aria-expanded="false">
            <span>
                <i class="bi bi-arrow-repeat me-2"></i> 
                {% if is_reading_mode %}ì§ì „ [êµ¬ë¬¸] ìˆ˜ì—… ì§„ë„{% else %}ì§ì „ [ë…í•´] ìˆ˜ì—… ì§„ë„{% endif %}
            </span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse" id="otherLogCollapse">
            <div class="info-content bg-light">
                {% if prev_log %}
                    <div class="d-flex justify-content-between text-muted small mb-2 border-bottom pb-1">
                        <span>ìˆ˜ì—…ì¼: {{ prev_log.date|date:"m/d (D)" }}</span>
                        <span>ì‘ì„±: {{ prev_log.teacher.staff_profile.name|default:prev_log.teacher.username }}</span>
                    </div>

                    {% for entry in prev_log.entries.all %}
                        {% if entry.textbook %}
                            <div class="mb-1"><span class="badge bg-secondary me-1">ì§„ë„</span> {{ entry.textbook.title }} ({{ entry.progress_range }})</div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if prev_log.comment %}
                        <div class="mt-2 p-2 bg-white rounded border text-muted small fst-italic">
                            "{{ prev_log.comment|truncatechars:60 }}"
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted small text-center">
                        {% if is_reading_mode %}êµ¬ë¬¸{% else %}ë…í•´{% endif %} ìˆ˜ì—… ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                {% endif %}
            </div>
        </div>

        <hr class="my-4 opacity-25">

        <form id="logForm" method="POST">
            {% csrf_token %}
            
            {% if not is_reading_mode %}
                <div class="section-title text-danger"><i class="bi bi-book"></i> ë‹¨ì–´ í…ŒìŠ¤íŠ¸</div>
                <div id="vocab-container"></div>
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="addVocabEntry()">+ ë‹¨ì–´ì¥ ì¶”ê°€</button>
                </div>
            {% else %}
                <div class="section-title text-warning"><i class="bi bi-puzzle"></i> ë…í•´ ë³µìŠµ í…ŒìŠ¤íŠ¸</div>
                <div class="card-entry reading-test-card mb-3">
                    <div class="mb-2">
                        <label class="form-label small text-muted">í…ŒìŠ¤íŠ¸ ìœ í˜•/ë‚´ìš©</label>
                        <input type="text" class="form-control" name="reading_test_type" 
                               value="{{ class_log.reading_test_type|default:'' }}" 
                               placeholder="ì˜ˆ: ë¹ˆì¹¸ì¶”ë¡ , ìˆœì„œë°°ì—´ ìœ í˜• í’€ì´ë²•">
                    </div>
                    <div>
                        <label class="form-label small text-muted">ê²°ê³¼/í”¼ë“œë°±</label>
                        <select class="form-select" name="reading_test_score">
                            <option value="">ê²°ê³¼ ì„ íƒ</option>
                            <option value="í†µê³¼" {% if class_log.reading_test_score == 'í†µê³¼' %}selected{% endif %}>ğŸŸ¢ í†µê³¼ (ì´í•´í•¨)</option>
                            <option value="ì¬ì‹œ" {% if class_log.reading_test_score == 'ì¬ì‹œ' %}selected{% endif %}>ğŸ”´ ì¬ì‹œ (ë³´ì¶© í•„ìš”)</option>
                            <option value="ë³´ë¥˜" {% if class_log.reading_test_score == 'ë³´ë¥˜' %}selected{% endif %}>ğŸŸ¡ ë³´ë¥˜ (ë‹¤ìŒ ì‹œê°„ í™•ì¸)</option>
                        </select>
                    </div>
                </div>
            {% endif %}

            <div class="section-title text-primary"><i class="bi bi-journal-text"></i> ìˆ˜ì—… ì§„ë„</div>
            
            {% if is_reading_mode %}
                <div class="alert alert-light border small py-2 mb-2 text-muted">
                    ğŸ’¡ ë…í•´ êµì¬ì™€ í’€ì´í•œ ì§€ë¬¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            {% endif %}
    
            <div id="main-container"></div>
            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addMainEntry()">+ êµì¬ ì¶”ê°€</button>
            </div>

            <div class="section-title"><i class="bi bi-chat-square-text"></i> ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</div>
            <textarea class="form-control bg-light" rows="3" name="comment" placeholder="í•™ìƒì˜ ì´í•´ë„, íƒœë„, íŠ¹ì´ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.">{{ class_log.comment }}</textarea>

            <div class="section-title mt-4 text-success"><i class="bi bi-house-door"></i> ë‹¤ìŒ ê³¼ì œ ë° ì•Œë¦¼</div>
            <div class="card p-3 border-0 bg-success bg-opacity-10 mb-3">
                
                {% if not is_reading_mode %}
                    <label class="form-label small text-success fw-bold">ğŸ“• ë‹¨ì–´ ê³¼ì œ</label>
                    <div id="hw-vocab-container"></div>
                    <button type="button" class="btn btn-sm btn-light border w-100 mb-3 text-success fw-bold" onclick="addHwVocabRow()">+ ë‹¨ì–´ ê³¼ì œ ì¶”ê°€</button>
                {% endif %}

                <label class="form-label small text-success fw-bold">ğŸ“˜ êµì¬ ê³¼ì œ</label>
                <div id="hw-main-container"></div>
                <button type="button" class="btn btn-sm btn-light border w-100 text-success fw-bold" onclick="addHwMainRow()">+ êµì¬ ê³¼ì œ ì¶”ê°€</button>

                <hr class="border-success opacity-25">

                <label class="form-label small text-success fw-bold">ğŸ’¬ ì•Œë¦¼í†¡ ë©˜íŠ¸</label>
                <textarea class="form-control" rows="2" name="teacher_comment" placeholder="í•™ë¶€ëª¨ë‹˜/í•™ìƒì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€">{{ class_log.teacher_comment|default:'' }}</textarea>
                
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="sendNotification" name="send_notification" value="on"
                        {% if not class_log.notification_sent_at %}checked{% endif %}>
                    <label class="form-check-label fw-bold small" for="sendNotification">ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ë°œì†¡</label>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // ë°ì´í„° ë¡œë“œ
    const syntaxBooks = {{ syntax_books_json|safe|default:"[]" }};
    const readingBooks = {{ reading_books_json|safe|default:"[]" }};
    const grammarBooks = {{ grammar_books_json|safe|default:"[]" }};
    const schoolExamBooks = {{ school_exam_books_json|safe|default:"[]" }};
    
    let vocabBooksByPublisher = {};
    try { vocabBooksByPublisher = {{ vocab_books_json|safe|default:"{}" }}; } catch (e) { console.error(e); }

    const vocabPublishers = [{% for p in vocab_publishers %}"{{ p|escapejs }}",{% endfor %}];
    let globalPublisherOptions = '<option value="">ì¶œíŒì‚¬</option>';
    vocabPublishers.forEach(pub => { globalPublisherOptions += `<option value="${pub}">${pub}</option>`; });

    // ë‹¨ì–´ì¥ í•„í„°ë§
    function filterVocabBooks(publisherSelect) {
        const bookEntry = publisherSelect.closest('.card-entry'); 
        const bookSelect = bookEntry.querySelector('.vocab-book-select');
        const selectedPublisher = publisherSelect.value;
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        if (selectedPublisher && vocabBooksByPublisher[selectedPublisher]) {
            vocabBooksByPublisher[selectedPublisher].forEach(book => {
                const option = document.createElement('option');
                option.value = book.id; option.textContent = book.title;
                bookSelect.appendChild(option);
            });
            bookSelect.disabled = false;
        } else { bookSelect.disabled = true; }
    }

    // [ìˆ˜ì •] êµì¬ í•„í„°ë§ í•¨ìˆ˜ (ë‚´ì‹  ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬ ì¶”ê°€)
    function filterBooks(subjectSelect) {
        const bookSelect = subjectSelect.closest('.card-entry').querySelector('.main-book-select');
        const selectedSubject = subjectSelect.value;
        
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        let books = [];

        if (selectedSubject === 'SYNTAX') books = syntaxBooks;
        else if (selectedSubject === 'READING') books = readingBooks;
        else if (selectedSubject === 'GRAMMAR') books = grammarBooks;
        else if (selectedSubject === 'SCHOOL_EXAM') books = schoolExamBooks; // [NEW] ë‚´ì‹  ì„ íƒ ì‹œ

        if (books && books.length > 0) {
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id; 
                option.textContent = book.title;
                bookSelect.appendChild(option);
            });
            bookSelect.disabled = false;
        } else { 
            bookSelect.disabled = true; 
        }
    }

    // ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ì¶”ê°€
    window.addVocabEntry = function() {
        const container = document.getElementById('vocab-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry'; 
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4"><select class="form-select form-select-sm" onchange="filterVocabBooks(this)">${globalPublisherOptions}</select></div>
                <div class="col-8"><select class="form-select form-select-sm vocab-book-select" name="vocab_book_ids[]" disabled><option value="">ì¶œíŒì‚¬ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-8"><label class="form-label small text-muted">ë²”ìœ„ (ì˜ˆ: 1-5)</label><input type="text" class="form-control form-control-sm" name="vocab_ranges[]"></div>
                <div class="col-4"><label class="form-label small text-muted">ì ìˆ˜</label><input type="text" class="form-control form-control-sm" name="vocab_scores[]"></div>
            </div>`;
        container.appendChild(newEntry);
    }

    // [ìˆ˜ì •] ìˆ˜ì—… ì§„ë„ ì¶”ê°€ (ë‚´ì‹  ì˜µì…˜ ì¶”ê°€ë¨)
    window.addMainEntry = function() {
        const container = document.getElementById('main-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry';
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4">
                    <select class="form-select form-select-sm" onchange="filterBooks(this)">
                        <option value="">ê³¼ëª©</option>
                        <option value="SYNTAX">êµ¬ë¬¸</option>
                        <option value="READING">ë…í•´</option>
                        <option value="GRAMMAR">ì–´ë²•</option>
                        <option value="SCHOOL_EXAM">ë‚´ì‹ </option> </select>
                </div>
                <div class="col-8"><select class="form-select form-select-sm main-book-select" name="main_book_ids[]" disabled><option value="">ê³¼ëª© ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-8"><label class="form-label small text-muted">ì§„ë„ (ì˜ˆ: 12-15)</label><input type="text" class="form-control form-control-sm" name="main_ranges[]"></div>
                <div class="col-4"><label class="form-label small text-muted">ìˆ˜í–‰ë„</label><select class="form-select form-select-sm" name="main_scores[]"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="F">F</option></select></div>
            </div>`;
        container.appendChild(newEntry);
    }

    // ë‹¨ì–´ ê³¼ì œ ì¶”ê°€
    window.addHwVocabRow = function() {
        const container = document.getElementById('hw-vocab-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry mb-2 position-relative'; 
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4"><select class="form-select form-select-sm vocab-publisher-select" onchange="filterVocabBooks(this)">${globalPublisherOptions}</select></div>
                <div class="col-8"><select class="form-select form-select-sm vocab-book-select" name="hw_vocab_book" disabled><option value="">ë‹¨ì–´ì¥ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-12"><input type="text" class="form-control form-control-sm" name="hw_vocab_range" placeholder="ë²”ìœ„ (ì˜ˆ: 1-5)"></div>
            </div>`;
        container.appendChild(newEntry);
    }

    // [ìˆ˜ì •] êµì¬ ê³¼ì œ ì¶”ê°€ (ë‚´ì‹  ì˜µì…˜ ì¶”ê°€ë¨)
    window.addHwMainRow = function() {
        const container = document.getElementById('hw-main-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry mb-2 position-relative';
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4">
                    <select class="form-select form-select-sm main-subject-select" onchange="filterBooks(this)">
                        <option value="">ê³¼ëª©</option>
                        <option value="SYNTAX">êµ¬ë¬¸</option>
                        <option value="READING">ë…í•´</option>
                        <option value="GRAMMAR">ì–´ë²•</option>
                        <option value="SCHOOL_EXAM">ë‚´ì‹ </option> </select>
                </div>
                <div class="col-8"><select class="form-select form-select-sm main-book-select" name="hw_main_book_id" disabled><option value="">êµì¬ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-12"><input type="text" class="form-control form-control-sm" name="hw_main_range" placeholder="ë²”ìœ„ (ì˜ˆ: 10-15)"></div>
            </div>`;
        container.appendChild(newEntry);
    }

    document.addEventListener('DOMContentLoaded', function() {
        addVocabEntry(); 
        addMainEntry(); 
        addHwVocabRow(); 
        addHwMainRow();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>