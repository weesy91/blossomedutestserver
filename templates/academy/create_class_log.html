<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¼ì§€ ì‘ì„±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; }
        .app-container { max-width: 600px; margin: 0 auto; background-color: white; min-height: 100vh; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: #6c757d; margin-bottom: 10px; margin-top: 20px;}
        .form-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 3px; }
        .card-entry { background-color: #f8f9fa; border: none; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .remove-btn { position: absolute; top: 10px; right: 10px; z-index: 10; font-size: 1.2rem; color: #adb5bd; cursor: pointer; line-height: 1; }
        .remove-btn:hover { color: #dc3545; }
        .reading-test-card { border-left: 4px solid #ffc107; background-color: #fffbf0; }
        
        /* ì•„ì½”ë””ì–¸(í´ë”©) ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .info-btn { 
            width: 100%; text-align: left; font-weight: bold; font-size: 0.9rem; 
            padding: 10px 15px; border-radius: 8px; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-my-hw { color: #0d6efd; background-color: #e7f1ff; border: 1px solid #b6d4fe; }
        .btn-other-log { color: #495057; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        
        /* ë‚´ìš© ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-content { 
            background-color: white; border: 1px solid #dee2e6; border-top: none; 
            border-radius: 0 0 8px 8px; padding: 15px; margin-bottom: 15px; margin-top: -5px;
        }
    </style>
</head>
<body>

<div class="app-container shadow-sm">
    <div class="px-3 py-3 border-bottom d-flex align-items-center justify-content-between sticky-top bg-white" style="z-index: 1020;">
        <a href="javascript:history.back()" class="btn btn-sm btn-light">âŒ ì·¨ì†Œ</a>
        <h5 class="m-0 fw-bold">{{ student.name }} <span class="text-primary small">({{ subject }})</span></h5>
        <button type="submit" form="logForm" class="btn btn-sm btn-primary px-3">ğŸ’¾ ì €ì¥</button>
    </div>

    <div class="p-3">
        
        <button class="btn info-btn btn-my-hw" type="button" data-bs-toggle="collapse" data-bs-target="#homeworkCollapse" aria-expanded="true">
            <span><i class="bi bi-clipboard-check me-2"></i>ì§€ë‚œ ì‹œê°„ ë‚´ì¤€ ìˆ™ì œ í™•ì¸</span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse show" id="homeworkCollapse">
            <div class="info-content border-primary border-opacity-25 bg-primary bg-opacity-10">
                {% if my_prev_log %}
                    <div class="d-flex justify-content-between text-muted small mb-2 border-bottom border-primary border-opacity-25 pb-1">
                        <span>ìˆ˜ì—…ì¼: {{ my_prev_log.date|date:"m/d (D)" }}</span>
                    </div>
                    
                    {% if my_prev_log.hw_vocab_range %}
                        <div class="mb-1"><span class="badge bg-danger">ë‹¨ì–´</span> {{ my_prev_log.hw_vocab_range }}</div>
                    {% endif %}
                    
                    {% if my_prev_log.hw_main_range %}
                        <div class="mb-1"><span class="badge bg-primary">êµì¬</span> {{ my_prev_log.hw_main_range }}</div>
                    {% endif %}

                    {% if not my_prev_log.hw_vocab_range and not my_prev_log.hw_main_range %}
                        <div class="text-muted small">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% endif %}

                    {% if my_prev_log.teacher_comment %}
                        <div class="mt-2 pt-2 border-top border-primary border-opacity-25 text-dark small fst-italic">
                            <i class="bi bi-chat-quote me-1"></i> {{ my_prev_log.teacher_comment }}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted small text-center">ì§€ë‚œ ìˆ˜ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}
            </div>
        </div>

        <button class="btn info-btn btn-other-log collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherLogCollapse" aria-expanded="false">
            <span>
                <i class="bi bi-arrow-repeat me-2"></i> 
                {% if is_reading_mode %}ì§ì „ [êµ¬ë¬¸] ìˆ˜ì—… ì§„ë„{% else %}ì§ì „ [ë…í•´] ìˆ˜ì—… ì§„ë„{% endif %}
            </span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse" id="otherLogCollapse">
            <div class="info-content bg-light">
                {% if prev_log %}
                    <div class="d-flex justify-content-between text-muted small mb-2 border-bottom pb-1">
                        <span>ìˆ˜ì—…ì¼: {{ prev_log.date|date:"m/d (D)" }}</span>
                        <span>ì‘ì„±: {{ prev_log.teacher.staff_profile.name|default:prev_log.teacher.username }}</span>
                    </div>

                    {% for entry in prev_log.entries.all %}
                        {% if entry.textbook %}
                            <div class="mb-1"><span class="badge bg-secondary me-1">ì§„ë„</span> {{ entry.textbook.title }} ({{ entry.progress_range }})</div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if prev_log.comment %}
                        <div class="mt-2 p-2 bg-white rounded border text-muted small fst-italic">
                            "{{ prev_log.comment|truncatechars:60 }}"
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted small text-center">
                        {% if is_reading_mode %}êµ¬ë¬¸{% else %}ë…í•´{% endif %} ìˆ˜ì—… ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                {% endif %}
            </div>
        </div>

        <hr class="my-4 opacity-25">

        <form id="logForm" method="POST">
            {% csrf_token %}
            
            {% if not is_reading_mode %}
                <div class="section-title text-danger"><i class="bi bi-book"></i> ë‹¨ì–´ í…ŒìŠ¤íŠ¸</div>
                <div id="vocab-container"></div>
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="addVocabEntry()">+ ë‹¨ì–´ì¥ ì¶”ê°€</button>
                </div>
            {% else %}
                <div class="section-title text-warning"><i class="bi bi-puzzle"></i> ë…í•´ ë³µìŠµ í…ŒìŠ¤íŠ¸</div>
                <div class="card-entry reading-test-card mb-3">
                    <div class="mb-2">
                        <label class="form-label small text-muted">í…ŒìŠ¤íŠ¸ ìœ í˜•/ë‚´ìš©</label>
                        <input type="text" class="form-control" name="reading_test_type" 
                               value="{{ class_log.reading_test_type|default:'' }}" 
                               placeholder="ì˜ˆ: ë¹ˆì¹¸ì¶”ë¡ , ìˆœì„œë°°ì—´ ìœ í˜• í’€ì´ë²•">
                    </div>
                    <div>
                        <label class="form-label small text-muted">ê²°ê³¼/í”¼ë“œë°±</label>
                        <select class="form-select" name="reading_test_score">
                            <option value="">ê²°ê³¼ ì„ íƒ</option>
                            <option value="í†µê³¼" {% if class_log.reading_test_score == 'í†µê³¼' %}selected{% endif %}>ğŸŸ¢ í†µê³¼ (ì´í•´í•¨)</option>
                            <option value="ì¬ì‹œ" {% if class_log.reading_test_score == 'ì¬ì‹œ' %}selected{% endif %}>ğŸ”´ ì¬ì‹œ (ë³´ì¶© í•„ìš”)</option>
                            <option value="ë³´ë¥˜" {% if class_log.reading_test_score == 'ë³´ë¥˜' %}selected{% endif %}>ğŸŸ¡ ë³´ë¥˜ (ë‹¤ìŒ ì‹œê°„ í™•ì¸)</option>
                        </select>
                    </div>
                </div>
            {% endif %}

            <div class="section-title text-primary"><i class="bi bi-journal-text"></i> ìˆ˜ì—… ì§„ë„</div>
            
            {% if is_reading_mode %}
                <div class="alert alert-light border small py-2 mb-2 text-muted">
                    ğŸ’¡ ë…í•´ êµì¬ì™€ í’€ì´í•œ ì§€ë¬¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            {% endif %}
    
            <div id="main-container"></div>
            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addMainEntry()">+ êµì¬ ì¶”ê°€</button>
            </div>

            <div class="section-title"><i class="bi bi-chat-square-text"></i> ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</div>
            <textarea class="form-control bg-light" rows="3" name="comment" placeholder="í•™ìƒì˜ ì´í•´ë„, íƒœë„, íŠ¹ì´ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.">{{ class_log.comment }}</textarea>

            <div class="section-title mt-4 text-success"><i class="bi bi-house-door"></i> ë‹¤ìŒ ê³¼ì œ ë° ì•Œë¦¼</div>
            <div class="card p-3 border-0 bg-success bg-opacity-10 mb-3">
                
                {% if not is_reading_mode %}
                    <label class="form-label small text-success fw-bold">ğŸ“• ë‹¨ì–´ ê³¼ì œ</label>
                    <div id="hw-vocab-container"></div>
                    <button type="button" class="btn btn-sm btn-light border w-100 mb-3 text-success fw-bold" onclick="addHwVocabRow()">+ ë‹¨ì–´ ê³¼ì œ ì¶”ê°€</button>
                {% endif %}

                <label class="form-label small text-success fw-bold">ğŸ“˜ êµì¬ ê³¼ì œ</label>
                <div id="hw-main-container"></div>
                <button type="button" class="btn btn-sm btn-light border w-100 text-success fw-bold" onclick="addHwMainRow()">+ êµì¬ ê³¼ì œ ì¶”ê°€</button>

                <hr class="border-success opacity-25">

                <label class="form-label small text-success fw-bold">ğŸ’¬ ì•Œë¦¼í†¡ ë©˜íŠ¸</label>
                <textarea class="form-control" rows="2" name="teacher_comment" placeholder="í•™ë¶€ëª¨ë‹˜/í•™ìƒì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€">{{ class_log.teacher_comment|default:'' }}</textarea>
                
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="sendNotification" name="send_notification" value="on"
                        {% if not class_log.notification_sent_at %}checked{% endif %}>
                    <label class="form-check-label fw-bold small" for="sendNotification">ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ë°œì†¡</label>
                </div>
            </div>

            <div class="p-3 mt-3 border-top">
                <h6 class="fw-bold text-secondary mb-3">
                    <i class="bi bi-clock-history me-1"></i> ì˜¤ëŠ˜ ë‹¨ì–´ ì‹œí—˜ ê¸°ë¡ (ì „ì²´ ì‹œë„)
                </h6>

                {% if today_vocab_results %}
                    <div class="accordion" id="vocabResultAccordion">
                        {% for result in today_vocab_results %}
                        <div class="accordion-item border-0 shadow-sm mb-2 rounded overflow-hidden">
                            <h2 class="accordion-header" id="heading{{ result.id }}">
                                <button class="accordion-button collapsed p-3 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ result.id }}" aria-expanded="false">
                                    <div class="d-flex flex-column w-100">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="fw-bold text-dark">{{ result.book.title }}</span>
                                            <span class="badge {% if result.score >= 27 %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                                {{ result.score }}ì  / {{ result.total_count }}ë¬¸ì œ
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>{{ result.created_at|date:"H:i" }} ì‘ì‹œ</span>
                                            <span>{% if result.score >= 27 %}ğŸ‰ í†µê³¼{% else %}âš ï¸ ì¬ì‹œí—˜ ëŒ€ìƒ{% endif %}</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ result.id }}" class="accordion-collapse collapse" data-bs-parent="#vocabResultAccordion">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0 small text-center align-middle">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th width="35%">ë¬¸ì œ</th>
                                                    <th width="30%">ì •ë‹µ</th>
                                                    <th width="25%">í•™ìƒë‹µ</th>
                                                    <th width="10%"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for detail in result.details.all %}
                                                <tr>
                                                    <td class="fw-bold">{{ detail.word_question }}</td>
                                                    
                                                    <td class="text-start text-truncate" style="max-width: 100px;" title="{{ detail.correct_answer }}">
                                                        {{ detail.correct_answer }}
                                                    </td>
                                                    
                                                    <td class="{% if detail.is_correct %}text-success{% else %}text-danger fw-bold{% endif %}">
                                                        {{ detail.student_answer }}
                                                    </td>
                                                    <td>
                                                        {% if detail.is_correct %}
                                                            <i class="bi bi-check-circle-fill text-success"></i>
                                                        {% else %}
                                                            <i class="bi bi-x-circle-fill text-danger"></i>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4 text-muted bg-light rounded">
                        <i class="bi bi-emoji-neutral fs-4 d-block mb-2"></i>
                        ì˜¤ëŠ˜ ì‘ì‹œí•œ ë‹¨ì–´ ì‹œí—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                {% endif %}
            </div>

        </form>
    </div>
</div>

<script>
    // 1. ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
    const syntaxBooks = {{ syntax_books_json|safe|default:"[]" }};
    const readingBooks = {{ reading_books_json|safe|default:"[]" }};
    const grammarBooks = {{ grammar_books_json|safe|default:"[]" }};
    const schoolExamBooks = {{ school_exam_books_json|safe|default:"[]" }};
    
    let vocabBooksByPublisher = {};
    try { vocabBooksByPublisher = {{ vocab_books_json|safe|default:"{}" }}; } catch (e) { console.error(e); }

    const vocabPublishers = [{% for p in vocab_publishers %}"{{ p|escapejs }}",{% endfor %}];
    let globalPublisherOptions = '<option value="">ì¶œíŒì‚¬</option>';
    vocabPublishers.forEach(pub => { globalPublisherOptions += `<option value="${pub}">${pub}</option>`; });

    const isReadonly = {{ is_readonly|yesno:"true,false" }};

    // 2. ë‹¨ì–´ì¥ í•„í„°ë§ í•¨ìˆ˜
    function filterVocabBooks(publisherSelect) {
        const bookEntry = publisherSelect.closest('.card-entry'); 
        const bookSelect = bookEntry.querySelector('.vocab-book-select');
        const selectedPublisher = publisherSelect.value;
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        if (selectedPublisher && vocabBooksByPublisher[selectedPublisher]) {
            vocabBooksByPublisher[selectedPublisher].forEach(book => {
                const option = document.createElement('option');
                option.value = book.id; option.textContent = book.title;
                bookSelect.appendChild(option);
            });
            bookSelect.disabled = false;
        } else { bookSelect.disabled = true; }
    }

    // 3. êµì¬ í•„í„°ë§ í•¨ìˆ˜
    function filterBooks(subjectSelect) {
        const bookSelect = subjectSelect.closest('.card-entry').querySelector('.main-book-select');
        const selectedSubject = subjectSelect.value;
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        let books = [];
        if (selectedSubject === 'SYNTAX') books = syntaxBooks;
        else if (selectedSubject === 'READING') books = readingBooks;
        else if (selectedSubject === 'GRAMMAR') books = grammarBooks;
        else if (selectedSubject === 'SCHOOL_EXAM') books = schoolExamBooks;

        if (books && books.length > 0) {
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id; option.textContent = book.title;
                bookSelect.appendChild(option);
            });
            bookSelect.disabled = false;
        } else { bookSelect.disabled = true; }
    }

    // 4. ë‹¨ì–´ í…ŒìŠ¤íŠ¸ í•­ëª© ì¶”ê°€
    window.addVocabEntry = function(data = null) {
        const container = document.getElementById('vocab-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry'; 
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4"><select class="form-select form-select-sm" onchange="filterVocabBooks(this)">${globalPublisherOptions}</select></div>
                <div class="col-8"><select class="form-select form-select-sm vocab-book-select" name="vocab_book_ids[]" disabled><option value="">ì¶œíŒì‚¬ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-8"><label class="form-label small text-muted">ë²”ìœ„</label><input type="text" class="form-control form-control-sm" name="vocab_ranges[]"></div>
                <div class="col-4"><label class="form-label small text-muted">ì ìˆ˜</label><input type="text" class="form-control form-control-sm" name="vocab_scores[]"></div>
            </div>`;
        container.appendChild(newEntry);

        if (data) {
            const pubSelect = newEntry.querySelector('select[onchange^="filterVocabBooks"]');
            pubSelect.value = data.publisher;
            filterVocabBooks(pubSelect);
            
            const bookSelect = newEntry.querySelector('.vocab-book-select');
            bookSelect.value = data.book_id;

            const inputs = newEntry.querySelectorAll('input');
            if(inputs[0]) inputs[0].value = data.range;
            if(inputs[1]) inputs[1].value = data.score;
        }

        if(isReadonly) disableEntry(newEntry);
    }

    // 5. êµì¬ ì§„ë„ í•­ëª© ì¶”ê°€
    window.addMainEntry = function(data = null) {
        const container = document.getElementById('main-container');
        if (!container) return; 

        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry';
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4">
                    <select class="form-select form-select-sm" onchange="filterBooks(this)">
                        <option value="">ê³¼ëª©</option>
                        <option value="SYNTAX">êµ¬ë¬¸</option>
                        <option value="READING">ë…í•´</option>
                        <option value="GRAMMAR">ì–´ë²•</option>
                        <option value="SCHOOL_EXAM">ë‚´ì‹ </option> </select>
                </div>
                <div class="col-8"><select class="form-select form-select-sm main-book-select" name="main_book_ids[]" disabled><option value="">êµì¬ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-8"><label class="form-label small text-muted">ì§„ë„</label><input type="text" class="form-control form-control-sm" name="main_ranges[]"></div>
                <div class="col-4"><label class="form-label small text-muted">ìˆ˜í–‰ë„</label><select class="form-select form-select-sm" name="main_scores[]"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="F">F</option></select></div>
            </div>`;
        container.appendChild(newEntry);

        if (data) {
            const subjectSelect = newEntry.querySelector('select[onchange^="filterBooks"]');
            subjectSelect.value = data.category;
            filterBooks(subjectSelect);
            
            const bookSelect = newEntry.querySelector('.main-book-select');
            bookSelect.value = data.book_id;
            
            const rangeInput = newEntry.querySelector('input[name="main_ranges[]"]');
            if(rangeInput) rangeInput.value = data.range;

            const scoreSelect = newEntry.querySelector('select[name="main_scores[]"]');
            if(scoreSelect) scoreSelect.value = data.score;
        }

        if(isReadonly) disableEntry(newEntry);
    }

    // 6. ê³¼ì œ í•­ëª© ì¶”ê°€ (ë‹¨ì–´)
    window.addHwVocabRow = function() {
        const container = document.getElementById('hw-vocab-container');
        if (!container) return; 
        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry mb-2 position-relative'; 
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4"><select class="form-select form-select-sm vocab-publisher-select" onchange="filterVocabBooks(this)">${globalPublisherOptions}</select></div>
                <div class="col-8"><select class="form-select form-select-sm vocab-book-select" name="hw_vocab_book" disabled><option value="">ë‹¨ì–´ì¥ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-12"><input type="text" class="form-control form-control-sm" name="hw_vocab_range" placeholder="ë²”ìœ„ (ì˜ˆ: 1-5)"></div>
            </div>`;
        container.appendChild(newEntry);
        if(isReadonly) disableEntry(newEntry);
    }

    // 7. ê³¼ì œ í•­ëª© ì¶”ê°€ (êµì¬)
    window.addHwMainRow = function() {
        const container = document.getElementById('hw-main-container');
        if (!container) return; 
        const newEntry = document.createElement('div');
        newEntry.className = 'card-entry mb-2 position-relative';
        newEntry.innerHTML = `
            <div class="remove-btn" onclick="this.parentElement.remove()">&times;</div>
            <div class="row g-2 mb-2 pe-3">
                <div class="col-4">
                    <select class="form-select form-select-sm main-subject-select" onchange="filterBooks(this)">
                        <option value="">ê³¼ëª©</option>
                        <option value="SYNTAX">êµ¬ë¬¸</option>
                        <option value="READING">ë…í•´</option>
                        <option value="GRAMMAR">ì–´ë²•</option>
                        <option value="SCHOOL_EXAM">ë‚´ì‹ </option> </select>
                </div>
                <div class="col-8"><select class="form-select form-select-sm main-book-select" name="hw_main_book_id" disabled><option value="">êµì¬ ì„ íƒ</option></select></div>
            </div>
            <div class="row g-2 pe-3">
                <div class="col-12"><input type="text" class="form-control form-control-sm" name="hw_main_range" placeholder="ë²”ìœ„ (ì˜ˆ: 10-15)"></div>
            </div>`;
        container.appendChild(newEntry);
        if(isReadonly) disableEntry(newEntry);
    }

    function disableEntry(element) {
        const inputs = element.querySelectorAll('input, select, textarea');
        inputs.forEach(el => { el.disabled = true; el.style.backgroundColor = '#e9ecef'; });
        const removeBtns = element.querySelectorAll('.remove-btn');
        removeBtns.forEach(btn => btn.style.display = 'none');
    }

    // [ì´ˆê¸° ì‹¤í–‰] ë°ì´í„° ë³µêµ¬
    document.addEventListener('DOMContentLoaded', function() {
        let hasVocab = false;
        let hasMain = false;

        // 1. ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ë³µêµ¬
        {% if class_log %}
            {% for entry in class_log.entries.all %}
                {% if entry.wordbook %}
                    addVocabEntry({
                        publisher: "{{ entry.wordbook.publisher.name|escapejs }}",
                        book_id: "{{ entry.wordbook.id }}",
                        range: "{{ entry.progress_range|escapejs }}",
                        score: "{{ entry.score|escapejs }}"
                    });
                    hasVocab = true;
                {% endif %}
            {% endfor %}

            // 2. ìˆ˜ì—… ì§„ë„ ë³µêµ¬
            {% for entry in class_log.entries.all %}
                {% if entry.textbook %}
                    addMainEntry({
                        category: "{{ entry.textbook.category|escapejs }}",
                        book_id: "{{ entry.textbook.id }}",
                        range: "{{ entry.progress_range|escapejs }}",
                        score: "{{ entry.score|escapejs }}"
                    });
                    hasMain = true;
                {% endif %}
            {% endfor %}
        {% endif %}

        if (!hasVocab) addVocabEntry();
        if (!hasMain) addMainEntry();
        
        // 3. ê³¼ì œ ë°ì´í„° ë³µêµ¬ (ë‹¨ì–´)
        const savedHwVocab = "{{ class_log.hw_vocab_range|escapejs }}";
        if (savedHwVocab) {
            const entries = savedHwVocab.split(" / ");
            entries.forEach(txt => {
                addHwVocabRow(); 
                const container = document.getElementById('hw-vocab-container');
                const lastRow = container.lastElementChild;
                const input = lastRow.querySelector('input[name="hw_vocab_range"]');
                if(input) input.value = txt;
            });
        } else {
            addHwVocabRow();
        }

        // 4. ê³¼ì œ ë°ì´í„° ë³µêµ¬ (êµì¬)
        const savedHwMain = "{{ class_log.hw_main_range|escapejs }}";
        if (savedHwMain) {
            const entries = savedHwMain.split(" / ");
            entries.forEach(txt => {
                addHwMainRow();
                const container = document.getElementById('hw-main-container');
                const lastRow = container.lastElementChild;
                const input = lastRow.querySelector('input[name="hw_main_range"]');
                if(input) input.value = txt;
            });
        } else {
            addHwMainRow(); 
        } // <--- ì—¬ê¸°ê°€ ë¹ ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤!

        // ì½ê¸° ì „ìš© ì²˜ë¦¬
        if (isReadonly) {
            const saveBtn = document.querySelector('button[type="submit"]');
            if(saveBtn) saveBtn.style.display = 'none';
            const allInputs = document.querySelectorAll('input, select, textarea');
            allInputs.forEach(el => { el.disabled = true; el.style.backgroundColor = '#e9ecef'; });
            const addButtons = document.querySelectorAll('button[onclick^="add"]');
            addButtons.forEach(btn => btn.style.display = 'none');
            const removeButtons = document.querySelectorAll('.remove-btn');
            removeButtons.forEach(btn => btn.style.display = 'none');
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>