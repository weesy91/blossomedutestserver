<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.month }}ì›” ì„±ì í‘œ - {{ student.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; }
        
        .card-box {
            background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: none;
        }

        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 40px 20px 30px;
            border-radius: 0 0 30px 30px; margin-bottom: 30px;
            text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-pills .nav-link {
            border-radius: 20px; color: #6c757d; font-weight: 600; font-size: 0.95rem;
            padding: 10px 18px; margin: 0 5px;
        }
        .nav-pills .nav-link.active {
            background-color: #4f46e5; color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        
        .log-item { border-left: 3px solid #e0e0e0; padding-left: 20px; margin-bottom: 25px; position: relative; }
        .log-item::before {
            content: ''; position: absolute; left: -6px; top: 0; width: 9px; height: 9px;
            border-radius: 50%; background: #4f46e5;
        }
        .log-date { font-weight: bold; color: #4f46e5; font-size: 0.9rem; margin-bottom: 4px;}
        .log-subject { font-size: 0.85rem; color: #6c757d; }
    </style>
</head>
<body>

    <div class="header-section">
        <h6 class="opacity-75 mb-1">{{ report.year }}ë…„ {{ report.month }}ì›”</h6>
        <h2 class="fw-bold mb-1">{{ student.name }} í•™ìƒ ì„±ì í‘œ</h2>
        <p class="small opacity-75">ë¸”ë¼ì¸ì—ë“€ ë™íƒ„ìº í¼ìŠ¤</p>
    </div>

    <div class="container" style="max-width: 800px;">
        
        <ul class="nav nav-pills justify-content-center mb-4" id="reportTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview">ì¢…í•©ë¶„ì„</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vocab-tab" data-bs-toggle="pill" data-bs-target="#vocab">ì–´íœ˜</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="lesson-tab" data-bs-toggle="pill" data-bs-target="#lesson">ìˆ˜ì—…ì¼ì§€</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="mock-tab" data-bs-toggle="pill" data-bs-target="#mock">ëª¨ì˜ê³ ì‚¬</button>
            </li>
        </ul>

        <div class="tab-content" id="reportTabContent">
            
            <div class="tab-pane fade show active" id="overview">
                <div class="card-box">
                    <h5 class="fw-bold mb-3 text-dark"><i class="bi bi-chat-quote-fill text-primary me-2"></i>ì„ ìƒë‹˜ ì´í‰</h5>
                    <div class="p-3 bg-light rounded text-secondary" style="white-space: pre-line; line-height: 1.6;">
                        {{ report.overall_comment|default:"ì‘ì„±ëœ ì´í‰ì´ ì—†ìŠµë‹ˆë‹¤." }}
                    </div>
                </div>

                <div class="card-box">
                    <h5 class="fw-bold mb-4 text-dark"><i class="bi bi-calendar-check text-success me-2"></i>ì´ë‹¬ì˜ ì¶œê²°</h5>
                    <div class="row text-center g-2">
                        <div class="col-4">
                            <div class="p-3 rounded bg-success bg-opacity-10">
                                <h2 class="text-success fw-bold mb-0">{{ report.present_days }}</h2>
                                <small class="text-muted fw-bold">ì¶œì„</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded bg-warning bg-opacity-10">
                                <h2 class="text-warning fw-bold mb-0">{{ report.late_days }}</h2>
                                <small class="text-muted fw-bold">ì§€ê°</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded bg-danger bg-opacity-10">
                                <h2 class="text-danger fw-bold mb-0">{{ report.absent_days }}</h2>
                                <small class="text-muted fw-bold">ê²°ì„</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3 text-muted small">
                         ì´ ìˆ˜ì—… ì¼ìˆ˜: {{ report.total_days }}ì¼
                    </div>
                </div>

                <div class="card-box">
                    <h5 class="fw-bold mb-3 text-dark"><i class="bi bi-graph-up text-danger me-2"></i>í•™ìŠµ ë°¸ëŸ°ìŠ¤</h5>
                    <div style="max-width: 350px; margin: 0 auto;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <p class="text-center text-muted small mt-3">
                        * ê° í•­ëª©ì€ 100ì  ë§Œì ìœ¼ë¡œ í™˜ì‚°ëœ ì ìˆ˜ì…ë‹ˆë‹¤.<br>
                        * ì„±ì‹¤ë„ëŠ” ì¶œê²° ë° ê³¼ì œ ìˆ˜í–‰ë¥ ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="tab-pane fade" id="vocab">
                <div class="card-box">
                    <h5 class="fw-bold mb-4">ğŸ“• ë‹¨ì–´ í•™ìŠµ ì„±ì·¨ë„</h5>
                    
                    <div class="row align-items-center mb-4">
                        <div class="col-6 text-center border-end">
                            <span class="text-muted small d-block mb-1">í‰ê·  ì ìˆ˜</span>
                            <span class="fw-bold fs-2 text-primary">{{ report.vocab_average_score }}</span>
                            <span class="text-muted small">/ 30</span>
                        </div>
                        <div class="col-6 text-center">
                            <span class="text-muted small d-block mb-1">ì´ ì‘ì‹œ</span>
                            <span class="fw-bold fs-2">{{ report.vocab_test_count }}</span>
                            <span class="text-muted small">íšŒ</span>
                        </div>
                    </div>
                    
                    <h6 class="text-muted small mb-2 fw-bold">ì‹œí—˜ í†µê³¼ìœ¨ (Pass Rate)</h6>
                    <div class="progress mb-4" style="height: 25px; border-radius: 12px;">
                        {% widthratio report.vocab_pass_count report.vocab_test_count 100 as pass_rate %}
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ pass_rate }}%">
                            {{ pass_rate }}%
                        </div>
                    </div>
                    
                    <ul class="list-group list-group-flush small">
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>í†µê³¼ (Pass)</span>
                            <span class="text-success fw-bold">{{ report.vocab_pass_count }}íšŒ</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>ì¬ì‹œí—˜ (Fail)</span>
                            <span class="text-danger fw-bold">{{ report.vocab_fail_count }}íšŒ</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="lesson">
                <div class="card-box">
                    <h5 class="fw-bold mb-4">ğŸ“ êµ¬ë¬¸/ë…í•´ ìˆ˜ì—… ê¸°ë¡</h5>
                    
                    {% if logs %}
                        {% for log in logs %}
                        <div class="log-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="log-date">{{ log.date|date:"mì›” dì¼" }} ({{ log.date|date:"D" }})</div>
                                    <span class="badge bg-secondary bg-opacity-10 text-dark border">{{ log.get_subject_display }}</span>
                                </div>
                                {% if log.teacher %}
                                <small class="text-muted">{{ log.teacher.staff_profile.name|default:log.teacher.username }} T</small>
                                {% endif %}
                            </div>
                            
                            <div class="bg-light p-3 rounded mb-2">
                                {% for entry in log.entries.all %}
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span class="fw-bold text-dark">ğŸ“˜ {{ entry.textbook.title|default:entry.wordbook.title }}</span>
                                        <span class="text-primary">{{ entry.progress_range }}</span>
                                    </div>
                                {% endfor %}
                            </div>

                            {% if log.comment %}
                            <div class="small text-secondary fst-italic">
                                <i class="bi bi-chat-right-quote me-1"></i> {{ log.comment }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-journal-x fs-1 d-block mb-2"></i>
                            ë“±ë¡ëœ ìˆ˜ì—… ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    {% endif %}
                </div>
            </div>
        <div class="tab-pane fade" id="mock">
    <div class="card-box">
        <h5 class="fw-bold mb-3"><i class="bi bi-graph-up-arrow text-primary me-2"></i>ì„±ì  ë³€í™” ì¶”ì´</h5>
        
        <div style="height: 300px; width: 100%;">
            <canvas id="mockChart"></canvas>
        </div>
        <p class="text-center text-muted small mt-2">
            * ìµœê·¼ ì‘ì‹œí•œ ëª¨ì˜ê³ ì‚¬ ì ìˆ˜ ë³€í™”ì…ë‹ˆë‹¤.
        </p>
    </div>

    <div class="card-box">
            <h5 class="fw-bold mb-4">ğŸ“‹ ìƒì„¸ ê¸°ë¡</h5>
            {% if mock_exams %}
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light small">
                            <tr>
                                <th>ì‹œí–‰ì¼</th>
                                <th>ì‹œí—˜ëª…</th>
                                <th class="text-center">ë“±ê¸‰</th>
                                <th class="text-center">ì ìˆ˜</th>
                                <th>ì˜¤ë‹µë¶„ì„</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exam in mock_exams %}
                            <tr>
                                <td class="small fw-bold">{{ exam.exam_date|date:"y.m.d" }}</td>
                                <td class="small">{{ exam.title }}</td>
                                <td class="text-center">
                                    <span class="badge bg-secondary rounded-pill">{{ exam.grade|default:"-" }}ë“±ê¸‰</span>
                                </td>
                                <td class="text-center fw-bold text-primary">{{ exam.score }}</td>
                                <td class="small text-muted">
                                    {% if exam.total_wrong > 0 %}
                                        <span class="text-danger">
                                            {% if exam.wrong_listening %}ë“£ê¸°(-{{exam.wrong_listening}}) {% endif %}
                                            {% if exam.wrong_vocab %}ì–´íœ˜(-{{exam.wrong_vocab}}) {% endif %}
                                            {% if exam.wrong_grammar %}ì–´ë²•(-{{exam.wrong_grammar}}) {% endif %}
                                            {% if exam.wrong_reading %}ë…í•´(-{{exam.wrong_reading}}){% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-success">ë§Œì  ğŸ‰</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5 text-muted">
                    ì•„ì§ ë“±ë¡ëœ ëª¨ì˜ê³ ì‚¬ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            {% endif %}
        </div>
    </div>    
        </div> 
    </div> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ì–´íœ˜(Voca)', 'êµ¬ë¬¸(Syntax)', 'ë…í•´(Reading)', 'ì„±ì‹¤ë„(Attitude)'],
                datasets: [{
                    label: 'ë‚´ ì ìˆ˜',
                    data: [
                        {{ report.exam_score_vocab }},
                        {{ report.exam_score_syntax }},
                        {{ report.exam_score_reading }},
                        90 // ì„±ì‹¤ë„ (ì„ì‹œê°’ - ì¶”í›„ ë¡œì§ ê°œë°œ í•„ìš”)
                    ],
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: '#4f46e5',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4f46e5',
                    pointRadius: 4,
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { display: false }, // ëˆˆê¸ˆ ìˆ«ì ìˆ¨ê¹€
                        pointLabels: {
                            font: { size: 12, weight: 'bold', family: "'Apple SD Gothic Neo', sans-serif" },
                            color: '#495057'
                        },
                        grid: { color: '#e9ecef' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
        const mockCtx = document.getElementById('mockChart');
        if (mockCtx) {
            const dates = JSON.parse('{{ graph_dates|safe }}');
            const scores = JSON.parse('{{ graph_scores|safe }}');
            const grades = JSON.parse('{{ graph_grades|safe }}');
            const titles = JSON.parse('{{ graph_titles|safe }}');

            if (dates.length > 0) {
                new Chart(mockCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'ì›ì ìˆ˜',
                            data: scores,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true,
                            tension: 0.3 // ê³¡ì„  íš¨ê³¼
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return titles[context[0].dataIndex]; // íˆ´íŒì— ì‹œí—˜ëª… í‘œì‹œ
                                    },
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        return ` ì ìˆ˜: ${context.raw}ì  (${grades[idx]}ë“±ê¸‰)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0, max: 100,
                                grid: { borderDash: [5, 5] }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë¬¸êµ¬
                mockCtx.parentElement.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
            }
        }
    </script>
</body>
</html>